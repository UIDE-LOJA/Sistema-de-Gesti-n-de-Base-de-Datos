<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Semana 2 - Transacciones y Control de Concurrencia</title>

    <!-- Reveal.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.6.1/dist/reveal.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.6.1/dist/theme/white.css" id="theme">

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.6.1/plugin/highlight/monokai.css">

    <!-- UIDE Theme CSS -->
    <link rel="stylesheet" href="../../assets/css/uide-theme.css">

    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="css/aipti-diagrams.css">
    <link rel="stylesheet" href="presentacion-clase-semana2.css">

    <!-- Mermaid.js -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

    <!-- D3.js for advanced visualizations -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>

<body>

    <!-- Floating Help Icon -->
    <div class="floating-help-emoji" onclick="showSGBDReference()" title="Guía Rápida de SGBD">
        <i class="fas fa-info-circle"></i>
    </div>

    <div class="reveal">
        <div class="slides">

            <!-- Title Slide -->
            <section data-background-color="#f8f8f8" data-transition="convex">
                <div class="title-slide">
                    <h1><i class="fas fa-database"></i> Presentación Semana 2</h1>
                    <h2>Transacciones y Control de Concurrencia</h2>

                    <div class="course-info">
                        <strong>LTI_05A_300 - SGBD</strong> • Quinto Nivel<br>
                        <strong>Sistemas de Gestión de Bases de Datos</strong><br>
                        <em>Prof. Charlie Alexander Cárdenas Toledo, M.Sc.</em><br>
                        Universidad Internacional del Ecuador • Octubre 2025
                    </div>

                    <div style="background: rgba(233, 171, 33, 0.1); border-radius: 8px; padding: 1em; margin: 1em 0; font-size: 0.9em;">
                        <strong>Propiedades ACID, Control de Concurrencia y Técnicas de Bloqueo</strong><br>
                        <em>Semana 2 • Transacciones • Niveles de Aislamiento • Fenómenos de Concurrencia</em>
                    </div>

                    <!-- Caso de Uso Integrador -->
                    <div style="background: rgba(40, 167, 69, 0.1); border-radius: 8px; padding: 1em; margin: 1em 0; font-size: 0.85em; border-left: 4px solid #388e3c;">
                        <strong><i class="fas fa-qrcode"></i> Caso de Estudio:</strong> Sistema de Pagos QR "¡ahorita!"<br>
                        <em>Hilo conductor para entender transacciones y concurrencia en contexto real</em>
                    </div>

                    <div style="margin-top: 2em; font-size: 0.9em; font-style: italic; color: var(--uide-secondary);">
                        Fundamentos para el procesamiento transaccional confiable y eficiente
                    </div>
                </div>
            </section>

            <!-- Caso de Uso: Hilo Conductor -->
            <section data-transition="convex">
                <h2><i class="fas fa-qrcode"></i> Caso de Uso: Pagos QR "¡ahorita!"</h2>
                
                <div class="concept-box">
                    <div class="r-hstack">
                        <div class="column">
                            <div style="background: rgba(35, 53, 110, 0.1); padding: 1.5rem; border-radius: 8px;">
                                <h4><i class="fas fa-database"></i> Esquema de Base de Datos</h4>
                                <pre style="background: #2d3748; color: #e2e8f0; padding: 1rem; border-radius: 6px; font-size: 0.75em;">
<code>CREATE TABLE Cuentas (
  id INT AUTO_INCREMENT PRIMARY KEY,
  titular VARCHAR(100) NOT NULL,
  saldo DECIMAL(15,2) NOT NULL DEFAULT 0.00,
  limite_diario DECIMAL(15,2) NOT NULL DEFAULT 100.00,
  estado ENUM('ACTIVA', 'BLOQUEADA') DEFAULT 'ACTIVA',
  fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT chk_saldo_positivo CHECK (saldo >= 0)
);

CREATE TABLE Comercios (
  id INT AUTO_INCREMENT PRIMARY KEY,
  nombre VARCHAR(100) NOT NULL,
  cuenta_bancoloja INT NOT NULL,
  qr_code VARCHAR(255) UNIQUE NOT NULL,
  ciudad VARCHAR(50) NOT NULL,
  estado ENUM('ACTIVO', 'INACTIVO') DEFAULT 'ACTIVO',
  fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (cuenta_bancoloja) REFERENCES Cuentas(id)
);

CREATE TABLE Pagos_QR (
  payment_id VARCHAR(50) PRIMARY KEY,
  cliente_id INT NOT NULL,
  comercio_id INT NOT NULL,
  monto DECIMAL(15,2) NOT NULL,
  fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  estado ENUM('PROCESANDO', 'CONFIRMADO', 'FALLIDO') DEFAULT 'PROCESANDO',
  FOREIGN KEY (cliente_id) REFERENCES Cuentas(id),
  FOREIGN KEY (comercio_id) REFERENCES Comercios(id),
  CONSTRAINT chk_monto_positivo CHECK (monto > 0)
);</code></pre>
                            </div>
                        </div>
                        <div class="column">
                            <div style="background: rgba(233, 171, 33, 0.1); padding: 1.5rem; border-radius: 8px;">
                                <h4><i class="fas fa-users"></i> Escenarios Reales con Nuestros Estudiantes</h4>
                                <ul style="font-size: 0.9em;">
                                    <li><strong>María José</strong> paga $2.50 almuerzo (QR restaurante, cuenta Banco de Loja)</li>
                                    <li><strong>Edgar</strong> paga $0.35 bus urbano (QR conductor afiliado al Banco de Loja)</li>
                                    <li><strong>Anyela</strong> compra $8.75 farmacia (QR caja, red de comercios Banco de Loja)</li>
                                    <li><strong>Carlo</strong> paga $15.00 gasolina (QR bomba, sistema interconectado)</li>
                                    <li><strong>Paula</strong> paga $1.25 café (QR mostrador, red "¡ahorita!")</li>
                                </ul>
                                <div style="background: rgba(145, 0, 72, 0.1); padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                                    <strong>¿Qué pasa cuando todos pagan simultáneamente en el mismo restaurante a las 12:30 hrs usando sus cuentas del Banco de Loja?</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Objetivos de la Presentación -->
            <section data-transition="convex">
                <h2><i class="fas fa-bullseye"></i> Objetivos de Aprendizaje</h2>

                <div class="concept-box">
                    <div style="background: rgba(40, 167, 69, 0.1); padding: 1.5rem; border-radius: 8px; text-align: center; margin-bottom: 1.5rem;">
                        <h4><i class="fas fa-university"></i> En esta sesión aprenderemos:</h4>
                    </div>

                    <div class="r-hstack">
                        <div class="column">
                            <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px;">
                                <h5><i class="fas fa-atom"></i> Comprender</h5>
                                <p style="font-size: 0.9em;">Que una <strong>transacción de pago QR</strong> es una unidad atómica completa</p>
                            </div>
                        </div>
                        <div class="column">
                            <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px;">
                                <h5><i class="fas fa-shield-alt"></i> Analizar</h5>
                                <p style="font-size: 0.9em;">Por qué <strong>ACID sostiene la confianza</strong> del usuario al pagar</p>
                            </div>
                        </div>
                    </div>

                    <div class="r-hstack" style="margin-top: 1rem;">
                        <div class="column">
                            <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px;">
                                <h5><i class="fas fa-lock"></i> Explorar</h5>
                                <p style="font-size: 0.9em;">Cómo evitar que <strong>pagos simultáneos</strong> generen inconsistencias</p>
                            </div>
                        </div>
                        <div class="column">
                            <div style="background: rgba(145, 0, 72, 0.1); padding: 1rem; border-radius: 8px;">
                                <h5><i class="fas fa-exclamation-triangle"></i> Resolver</h5>
                                <p style="font-size: 0.9em;"><strong>Deadlocks</strong> al acreditar a un mismo comercio en hora pico</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Agenda -->
            <section>
                <h3><i class="fas fa-list-ul"></i> Agenda</h3>
                <h4 style="text-align: center; color: var(--uide-accent); margin-bottom: 1.5rem;">
                    <i class="fas fa-university"></i> Aplicado a Sistemas de Pagos QR
                </h4>
                <div class="concept-box">
                    <div class="r-hstack">
                        <div class="column">
                            <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px;">
                                <h5><i class="fas fa-exchange-alt"></i> 1. Transacciones QR</h5>
                                <p style="font-size: 0.8em; margin: 0.3rem 0;">Anatomía de un pago instantáneo</p>
                            </div>
                        </div>
                        <div class="column">
                            <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px;">
                                <h5><i class="fas fa-shield-alt"></i> 2. Propiedades ACID</h5>
                                <p style="font-size: 0.8em; margin: 0.3rem 0;">Confianza en pagos móviles</p>
                            </div>
                        </div>
                    </div>

                    <div class="r-hstack" style="margin-top: 1rem;">
                        <div class="column">
                            <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px;">
                                <h5><i class="fas fa-lock"></i> 3. Control de Concurrencia</h5>
                                <p style="font-size: 0.8em; margin: 0.3rem 0;">Pagos simultáneos sin conflictos</p>
                            </div>
                        </div>
                        <div class="column">
                            <div style="background: rgba(145, 0, 72, 0.1); padding: 1rem; border-radius: 8px;">
                                <h5><i class="fas fa-check-circle"></i> 4. Técnicas de Bloqueo</h5>
                                <p style="font-size: 0.8em; margin: 0.3rem 0;">Hotspots de comercios populares</p>
                            </div>
                        </div>
                    </div>

                    <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem; text-align: center;">
                        <h5><i class="fas fa-flask"></i> 5. Mini-Lab: Dos Pagos Simultáneos</h5>
                        <p style="font-size: 0.8em; margin: 0.3rem 0;">Simulación práctica de contención en el mismo comercio</p>
                    </div>
                </div>
            </section>

            <!-- Conceptos de Transacciones -->
            <section data-transition="convex">
                <h2><i class="fas fa-exchange-alt"></i> Conceptos de Transacciones</h2>

                <section>
                    <h3>Definición Fundamental</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--uide-primary); font-style: italic; font-size: 0.95em; margin-bottom: 1rem;">
                            "Una transacción es una unidad de la ejecución de un programa que puede estar compuesta por varias operaciones de acceso a la base de datos"
                        </blockquote>

                        <div class="r-hstack">
                            <div class="column">
                                <h4><i class="fas fa-university"></i> Ejemplo: Pago QR</h4>
                                <div style="background: rgba(35, 53, 110, 0.1); padding: 0.8rem; border-radius: 8px;">
                                    <pre style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.7em;">
<code>START TRANSACTION;
-- Verificar saldo
SELECT saldo FROM Cuentas WHERE id = 101;
-- Debitar cliente
UPDATE Cuentas SET saldo = saldo - 2.50 WHERE id = 101;
-- Acreditar comercio
UPDATE Cuentas SET saldo = saldo + 2.50 WHERE id = 205;
-- Registrar pago
INSERT INTO Pagos_QR (payment_id, cliente_id, comercio_id, monto, fecha, estado) 
VALUES ('PAY_20251106_101_205_001', 101, 205, 2.50, NOW(), 'CONFIRMADO');
COMMIT;</code></pre>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-cogs"></i> Operaciones de Control</h4>
                                <ul style="font-size: 0.9em;">
                                    <li><strong>BEGIN</strong>: Inicio de la transacción</li>
                                    <li><strong>COMMIT</strong>: Confirma los cambios permanentemente</li>
                                    <li><strong>ROLLBACK</strong>: Cancela la transacción y deshace cambios</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3>Estados de una Transacción</h3>
                    <div class="concept-box">
                        <div class="r-hstack">
                            <div class="column">
                                <h4><i class="fas fa-play"></i> Estados Básicos</h4>
                                <ul style="font-size: 0.9em;">
                                    <li><strong><i class="fas fa-circle text-warning"></i> Activa:</strong> Ejecutando operaciones</li>
                                    <li><strong><i class="fas fa-circle text-success"></i> Confirmada:</strong> COMMIT exitoso</li>
                                    <li><strong><i class="fas fa-circle text-danger"></i> Abortada:</strong> ROLLBACK ejecutado</li>
                                </ul>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-mobile-alt"></i> En Pagos QR</h4>
                                <ul style="font-size: 0.9em;">
                                    <li><strong>Activa:</strong> "Procesando pago..."</li>
                                    <li><strong>Confirmada:</strong> "¡Pago exitoso!"</li>
                                    <li><strong>Abortada:</strong> "Pago fallido"</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>
            </section>

            <!-- Propiedades ACID -->
            <section data-transition="convex">
                <h2><i class="fas fa-shield-alt"></i> Propiedades ACID</h2>

                <section>
                    <h3>Fundamentos ACID</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(35, 53, 110, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-primary); font-style: italic; font-size: 1.0em;">
                            "Propiedades que aseguran el procesamiento confiable de las transacciones de bases de datos"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                                    <h4><i class="fas fa-atom"></i> Atomicidad</h4>
                                    <p style="font-size: 0.9em;">Todo o nada</p>
                                </div>
                            </div>
                            <div class="column">
                                <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                                    <h4><i class="fas fa-check-circle"></i> Consistencia</h4>
                                    <p style="font-size: 0.9em;">Estados válidos</p>
                                </div>
                            </div>
                        </div>

                        <div class="r-hstack" style="margin-top: 1rem;">
                            <div class="column">
                                <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                                    <h4><i class="fas fa-user-secret"></i> Aislamiento</h4>
                                    <p style="font-size: 0.9em;">Independencia</p>
                                </div>
                            </div>
                            <div class="column">
                                <div style="background: rgba(145, 0, 72, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                                    <h4><i class="fas fa-save"></i> Durabilidad</h4>
                                    <p style="font-size: 0.9em;">Permanencia</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-atom"></i> Atomicidad en Pagos QR</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(40, 167, 69, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-primary); font-style: italic; font-size: 1.0em;">
                            "Un pago QR no puede 'quedar a medias': o se debita y acredita, o nada"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-university"></i> Escenario de Falla</h4>
                                <div style="background: rgba(220, 53, 69, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-wifi"></i> ¡Falla de conexión durante pago QR!</h5>
                                    <pre style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.7em;">
<code>START TRANSACTION;
-- [OK] Verificación exitosa
SELECT saldo FROM Cuentas WHERE id = 101; -- $25.00

-- [OK] Débito ejecutado
UPDATE Cuentas SET saldo = saldo - 2.50 
WHERE id = 101; -- Queda $22.50

-- [!] FALLA DE CONEXIÓN AQUÍ [!]

-- [X] Crédito no ejecutado
UPDATE Cuentas SET saldo = saldo + 2.50 
WHERE id = 205; -- Restaurante no recibe

-- [X] Registro no creado
INSERT INTO Pagos_QR (payment_id, cliente_id, comercio_id, monto, fecha, estado) 
VALUES ('PAY_20251106_101_205_002', 101, 205, 2.50, NOW(), 'PROCESANDO');

COMMIT; -- [X] No alcanzado</code></pre>
                                    <p style="font-size: 0.8em; margin: 0.5rem 0;"><strong>Resultado:</strong> Al reconectar, el SGBD detecta la transacción incompleta y hace <strong>ROLLBACK automático</strong>. María José conserva sus $25.00, el restaurante no pierde nada.</p>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-shield-alt"></i> Garantías en Pagos Móviles</h4>
                                <ul style="font-size: 0.9em;">
                                    <li><strong>Rollback automático</strong>: Deshace débitos sin créditos correspondientes</li>
                                    <li><strong>Idempotencia</strong>: Reintentos seguros con mismo payment_id</li>
                                    <li><strong>Timeout inteligente</strong>: Aborta transacciones colgadas</li>
                                    <li><strong>Validación previa</strong>: Verificación de reglas de negocio</li>
                                </ul>
                                
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-mobile-alt"></i> Experiencia del Usuario</h5>
                                    <p style="font-size: 0.8em; margin: 0;">Los usuarios confían en que <strong>nunca pagarán sin recibir confirmación</strong> y que <strong>nunca se les cobrará doble</strong>. La atomicidad lo garantiza.</p>
                                </div>


                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-check-circle"></i> Consistencia en Pagos QR</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(35, 53, 110, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-primary); font-style: italic; font-size: 1.0em;">
                            "Reglas de negocio: saldo ≥ 0, límites diarios, comercio activo, antifraude"
                        </blockquote>

                        <div style="text-align: center; margin-top: 1.5rem;">
                            <p style="font-size: 1.1em; color: var(--uide-accent);">
                                <strong>La consistencia garantiza que el sistema siempre mantenga estados válidos</strong>
                            </p>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-calculator"></i> Invariante: Conservación del Dinero</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(35, 53, 110, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-primary); font-style: italic; font-size: 1.0em;">
                            "El dinero total del sistema NUNCA cambia - solo se transfiere entre cuentas"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-balance-scale"></i> Ejemplo: Pago de Almuerzo</h4>
                                <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px;">
                                    <pre style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.75em;">
<code>-- ANTES del pago QR
Saldo_MaríaJosé = $25.00
Saldo_Restaurante = $450.00
Total_Sistema = $475.00

-- DESPUÉS de pagar $2.50 almuerzo
Saldo_MaríaJosé = $22.50
Saldo_Restaurante = $452.50
Total_Sistema = $475.00 ✅

-- Regla: El dinero total NUNCA cambia</code></pre>
                                </div>
                                
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-check-circle"></i> Verificación Automática</h5>
                                    <p style="font-size: 0.85em; margin: 0;">El SGBD verifica que cada transacción mantenga el balance total. Si hay discrepancia, la transacción se aborta automáticamente.</p>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-shield-alt"></i> Mecanismos de Protección</h4>
                                <ul style="font-size: 0.9em;">
                                    <li><strong>Constraints CHECK</strong>: Saldo ≥ 0 en todas las cuentas</li>
                                    <li><strong>Foreign Keys</strong>: Referencias válidas entre tablas</li>
                                    <li><strong>Triggers</strong>: Validaciones complejas automáticas</li>
                                    <li><strong>Transacciones atómicas</strong>: Todo o nada</li>
                                </ul>
                                
                                <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-lightbulb"></i> Principio Clave</h5>
                                    <p style="font-size: 0.85em; margin: 0;">En sistemas financieros, <strong>la consistencia es más importante que la velocidad</strong>. Es mejor rechazar una transacción que permitir un estado inconsistente.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-ban"></i> Detección de Violaciones</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(220, 53, 69, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #dc3545; font-style: italic; font-size: 1.0em;">
                            "El sistema detecta y rechaza automáticamente operaciones que violan las reglas de negocio"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-exclamation-triangle"></i> Violaciones Comunes</h4>
                                <div style="background: rgba(220, 53, 69, 0.1); padding: 1rem; border-radius: 8px;">
                                    <pre style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.7em;">
<code>-- ❌ Intento de sobregiro
UPDATE Cuentas SET saldo = saldo - 30.00 
WHERE id = 101 AND saldo = 25.00;
-- Error: CHECK constraint 'chk_saldo_positivo' failed

-- ❌ Exceder límite diario
-- María José ya gastó $45.00 hoy, límite $50.00
-- Intenta pagar $8.00 más
-- Error: "Límite diario excedido"

-- ❌ Comercio inactivo
UPDATE Cuentas SET saldo = saldo + 5.00 
WHERE id IN (SELECT cuenta_bancoloja FROM Comercios 
             WHERE estado = 'INACTIVO');
-- Error: "Comercio no disponible"</code></pre>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-user-shield"></i> Experiencia del Usuario</h4>
                                <ul style="font-size: 0.9em;">
                                    <li><strong>Mensajes claros</strong>: "Saldo insuficiente: $25.00 disponible"</li>
                                    <li><strong>Validación previa</strong>: Verificación antes de procesar</li>
                                    <li><strong>Estados seguros</strong>: Nunca se muestran datos inconsistentes</li>
                                    <li><strong>Rollback automático</strong>: Deshace cambios parciales</li>
                                </ul>
                                
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-mobile-alt"></i> En la App Móvil</h5>
                                    <p style="font-size: 0.85em; margin: 0;">Si María José intenta pagar $30.00 teniendo $25.00, recibe "Saldo insuficiente" <strong>antes</strong> de que se ejecute cualquier operación en la base de datos.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-cogs"></i> Restricciones del Sistema</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(233, 171, 33, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-accent); font-style: italic; font-size: 1.0em;">
                            "Múltiples capas de validación garantizan la integridad del sistema de pagos"
                        </blockquote>

                        <div style="text-align: center; margin-top: 1.5rem;">
                            <p style="font-size: 1.1em; color: var(--uide-accent);">
                                <strong>Arquitectura de seguridad en 3 niveles para proteger cada transacción</strong>
                            </p>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-database"></i> Nivel 1: Restricciones de Base de Datos</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(35, 53, 110, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-primary); font-style: italic; font-size: 1.0em;">
                            "Constraints automáticos que el SGBD aplica en cada operación"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-check-square"></i> CHECK Constraints</h4>
                                <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px;">
                                    <pre style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.75em;">
<code>-- Saldo nunca negativo
CONSTRAINT chk_saldo_positivo 
CHECK (saldo >= 0)

-- Monto de pago siempre positivo
CONSTRAINT chk_monto_positivo 
CHECK (monto > 0)

-- Límite diario válido
CONSTRAINT chk_limite_positivo 
CHECK (limite_diario > 0)</code></pre>
                                </div>
                                
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-lightning-bolt"></i> Aplicación Automática</h5>
                                    <p style="font-size: 0.85em; margin: 0;">MySQL verifica estos constraints en <strong>cada INSERT/UPDATE</strong>. Si fallan, la operación se aborta inmediatamente.</p>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-link"></i> Foreign Key Constraints</h4>
                                <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px;">
                                    <pre style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.75em;">
<code>-- Cliente debe existir
FOREIGN KEY (cliente_id) 
REFERENCES Cuentas(id)

-- Comercio debe existir
FOREIGN KEY (comercio_id) 
REFERENCES Comercios(id)

-- Cuenta de comercio válida
FOREIGN KEY (cuenta_bancoloja) 
REFERENCES Cuentas(id)</code></pre>
                                </div>
                                
                                <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-shield-alt"></i> Integridad Referencial</h5>
                                    <p style="font-size: 0.85em; margin: 0;">Imposible crear pagos a clientes o comercios inexistentes. Garantiza que todas las referencias sean válidas.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-mobile-alt"></i> Nivel 2: Validaciones de Aplicación</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(40, 167, 69, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #28a745; font-style: italic; font-size: 1.0em;">
                            "Reglas de negocio específicas del sistema de pagos móviles"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-calendar-day"></i> Límites Diarios</h4>
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-user"></i> Por Cliente</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li>María José: $50.00/día máximo</li>
                                        <li>Edgar: $40.00/día máximo</li>
                                        <li>Carlo: $80.00/día máximo</li>
                                    </ul>
                                    
                                    <h5><i class="fas fa-store"></i> Por Tipo de Comercio</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li>Transporte: $5.00 máximo por pago</li>
                                        <li>Restaurantes: $15.00 máximo por pago</li>
                                        <li>Gasolineras: $50.00 máximo por pago</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-clock"></i> Restricciones Temporales</h4>
                                <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-business-time"></i> Horarios de Comercios</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li>Restaurantes: 06:00 - 22:00</li>
                                        <li>Farmacias: 24/7</li>
                                        <li>Transporte: 05:00 - 23:00</li>
                                    </ul>
                                    
                                    <h5><i class="fas fa-user-shield"></i> Detección de Fraude</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li>Más de 5 pagos en 1 minuto</li>
                                        <li>Pagos desde ubicaciones distantes</li>
                                        <li>Patrones de gasto inusuales</li>
                                    </ul>
                                </div>
                                
                                <div style="background: rgba(145, 0, 72, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-exclamation-triangle"></i> Alertas Automáticas</h5>
                                    <p style="font-size: 0.85em; margin: 0;">El sistema bloquea temporalmente cuentas con patrones sospechosos y notifica al equipo de seguridad.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-building"></i> Nivel 3: Políticas de Negocio</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(145, 0, 72, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #91004a; font-style: italic; font-size: 1.0em;">
                            "Reglas estratégicas del Banco de Loja y regulaciones financieras"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-chart-line"></i> Políticas de Riesgo</h4>
                                <div style="background: rgba(145, 0, 72, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-percentage"></i> Límites por Perfil</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li><strong>Estudiantes:</strong> $100/día máximo</li>
                                        <li><strong>Empleados:</strong> $500/día máximo</li>
                                        <li><strong>Empresas:</strong> $2000/día máximo</li>
                                    </ul>
                                    
                                    <h5><i class="fas fa-map-marker-alt"></i> Restricciones Geográficas</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li>Solo comercios en Loja y Catamayo</li>
                                        <li>Bloqueo automático fuera de Ecuador</li>
                                        <li>Validación de GPS en pagos grandes</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-balance-scale"></i> Cumplimiento Regulatorio</h4>
                                <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-university"></i> Superintendencia de Bancos</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li>Reporte de transacciones > $1000</li>
                                        <li>Auditoría completa de operaciones</li>
                                        <li>Retención de logs por 7 años</li>
                                    </ul>
                                    
                                    <h5><i class="fas fa-lock"></i> Protección de Datos</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li>Encriptación de datos sensibles</li>
                                        <li>Anonimización de reportes</li>
                                        <li>Consentimiento explícito del usuario</li>
                                    </ul>
                                </div>
                                
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-award"></i> Certificaciones</h5>
                                    <p style="font-size: 0.85em; margin: 0;">Sistema certificado PCI-DSS para manejo seguro de datos de pagos y cumplimiento ISO 27001.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-robot"></i> Proceso de Validación Integrado</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(233, 171, 33, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-accent); font-style: italic; font-size: 1.0em;">
                            "Flujo automático que aplica todas las restricciones en secuencia"
                        </blockquote>

                        <div style="text-align: center; margin-top: 1.5rem;">
                            <p style="font-size: 1.1em; color: var(--uide-accent);">
                                <strong>Pipeline de validación en 4 etapas para garantizar transacciones seguras</strong>
                            </p>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-search"></i> Etapa 1: Pre-validación</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(40, 167, 69, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #28a745; font-style: italic; font-size: 1.0em;">
                            "Verificación básica de formato y completitud de datos antes del procesamiento"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-clipboard-check"></i> Validaciones de Formato</h4>
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-hashtag"></i> Campos Obligatorios</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li><strong>payment_id:</strong> Formato PAY_YYYYMMDD_XXX_YYY_ZZZ</li>
                                        <li><strong>cliente_id:</strong> Número entero válido</li>
                                        <li><strong>comercio_id:</strong> Número entero válido</li>
                                        <li><strong>monto:</strong> Decimal positivo con 2 decimales</li>
                                    </ul>
                                    
                                    <h5><i class="fas fa-ruler"></i> Rangos de Valores</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li><strong>Monto mínimo:</strong> $0.01</li>
                                        <li><strong>Monto máximo:</strong> $999.99 por transacción</li>
                                        <li><strong>Descripción:</strong> Máximo 200 caracteres</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-exclamation-triangle"></i> Errores Comunes Detectados</h4>
                                <div style="background: rgba(220, 53, 69, 0.1); padding: 1rem; border-radius: 8px;">
                                    <pre style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.7em;">
<code>❌ payment_id vacío o formato incorrecto
   "PAY_INVALID_FORMAT"
   → Error: "ID de pago inválido"

❌ Monto con formato incorrecto
   monto = "dos cincuenta"
   → Error: "Monto debe ser numérico"

❌ Cliente ID inexistente
   cliente_id = 999
   → Error: "Cliente no encontrado"

❌ Monto fuera de rango
   monto = 1500.00
   → Error: "Monto excede límite máximo"</code></pre>
                                </div>
                                
                                <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-clock"></i> Tiempo de Respuesta</h5>
                                    <p style="font-size: 0.85em; margin: 0;">Pre-validación completa en <strong>< 50ms</strong>. Errores detectados aquí evitan procesamiento innecesario.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-cogs"></i> Etapa 2: Validación de Negocio</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(35, 53, 110, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-primary); font-style: italic; font-size: 1.0em;">
                            "Aplicación de reglas específicas del sistema de pagos y políticas del banco"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-calendar-day"></i> Límites y Restricciones</h4>
                                <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-user"></i> Límites por Cliente</h5>
                                    <pre style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.7em;">
<code>-- Verificar límite diario de María José
SELECT 
    c.limite_diario,
    COALESCE(ld.monto_acumulado, 0) AS gastado_hoy,
    (c.limite_diario - COALESCE(ld.monto_acumulado, 0)) AS disponible
FROM Cuentas c
LEFT JOIN Limites_Diarios ld ON c.id = ld.cliente_id 
    AND ld.fecha = CURDATE()
WHERE c.id = 101;

-- Resultado: $50.00 límite, $22.50 gastado, $27.50 disponible</code></pre>
                                    
                                    <h5><i class="fas fa-store"></i> Estado del Comercio</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li>Comercio debe estar ACTIVO</li>
                                        <li>Horario de atención válido</li>
                                        <li>Cuenta del comercio operativa</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-shield-alt"></i> Detección de Fraude</h4>
                                <div style="background: rgba(145, 0, 72, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-exclamation-triangle"></i> Patrones Sospechosos</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li><strong>Velocidad:</strong> > 5 pagos en 1 minuto</li>
                                        <li><strong>Ubicación:</strong> Pagos desde ciudades distantes</li>
                                        <li><strong>Horario:</strong> Pagos a las 3:00 AM</li>
                                        <li><strong>Monto:</strong> Cambio drástico en patrón de gasto</li>
                                    </ul>
                                    
                                    <h5><i class="fas fa-robot"></i> Acción Automática</h5>
                                    <p style="font-size: 0.85em; margin: 0.5rem 0;">Si se detecta patrón sospechoso:</p>
                                    <ol style="font-size: 0.8em; margin: 0.3rem 0;">
                                        <li>Bloqueo temporal de cuenta (15 min)</li>
                                        <li>Notificación SMS al cliente</li>
                                        <li>Alerta al equipo de seguridad</li>
                                        <li>Registro en log de auditoría</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-database"></i> Etapa 3: Validación de Integridad</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(233, 171, 33, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-accent); font-style: italic; font-size: 1.0em;">
                            "Constraints automáticos de la base de datos que garantizan consistencia"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-check-square"></i> Constraints Aplicados</h4>
                                <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px;">
                                    <pre style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.7em;">
<code>-- Durante la transacción de pago
START TRANSACTION;

-- 1. Verificar saldo suficiente (CHECK constraint)
UPDATE Cuentas SET saldo = saldo - 2.50 
WHERE id = 101;
-- Si saldo < 0 → Error automático

-- 2. Verificar unicidad de payment_id
INSERT INTO Pagos_QR (payment_id, ...)
VALUES ('PAY_20241106_101_205_001', ...);
-- Si payment_id existe → Error automático

-- 3. Verificar foreign keys
-- cliente_id y comercio_id deben existir
-- Si no existen → Error automático

COMMIT;</code></pre>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-lightning-bolt"></i> Aplicación Automática</h4>
                                <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-cog"></i> Nivel de SGBD</h5>
                                    <p style="font-size: 0.85em; margin: 0.5rem 0;">MySQL aplica estos constraints <strong>automáticamente</strong> en cada operación. No hay forma de evitarlos.</p>
                                    
                                    <h5><i class="fas fa-stopwatch"></i> Rendimiento</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li>Verificación en <strong>microsegundos</strong></li>
                                        <li>Optimizada por índices de BD</li>
                                        <li>Sin impacto perceptible al usuario</li>
                                    </ul>
                                    
                                    <h5><i class="fas fa-shield-alt"></i> Garantía Absoluta</h5>
                                    <p style="font-size: 0.85em; margin: 0.5rem 0;">Es <strong>imposible</strong> que una transacción viole estos constraints. El SGBD lo impide a nivel físico.</p>
                                </div>
                                
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-check-circle"></i> Resultado</h5>
                                    <p style="font-size: 0.85em; margin: 0;">Si llega hasta aquí, la transacción es <strong>técnicamente válida</strong> y puede proceder al COMMIT.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-check-double"></i> Etapa 4: Post-validación y Auditoría</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(145, 0, 72, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #91004a; font-style: italic; font-size: 1.0em;">
                            "Verificación final, registro de auditoría y notificaciones al usuario"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-clipboard-list"></i> Verificación Final</h4>
                                <div style="background: rgba(145, 0, 72, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-calculator"></i> Balance de Cuentas</h5>
                                    <pre style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.7em;">
<code>-- Verificar que el dinero se conservó
SELECT 
    'ANTES' AS momento,
    (SELECT SUM(saldo) FROM Cuentas WHERE id IN (101, 201)) AS total
UNION ALL
SELECT 
    'DESPUÉS' AS momento,
    (SELECT SUM(saldo) FROM Cuentas WHERE id IN (101, 201)) AS total;

-- Resultado debe ser idéntico:
-- ANTES:  $475.00
-- DESPUÉS: $475.00 ✅</code></pre>
                                    
                                    <h5><i class="fas fa-file-alt"></i> Registro de Auditoría</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li>Timestamp exacto de la operación</li>
                                        <li>Usuario y dispositivo origen</li>
                                        <li>Valores antes y después</li>
                                        <li>Resultado de cada validación</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-bell"></i> Notificaciones y Respuesta</h4>
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-mobile-alt"></i> Al Cliente</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li><strong>Push notification:</strong> "Pago exitoso $2.50"</li>
                                        <li><strong>SMS:</strong> Confirmación con código único</li>
                                        <li><strong>Email:</strong> Recibo detallado (opcional)</li>
                                        <li><strong>App:</strong> Actualización de saldo en tiempo real</li>
                                    </ul>
                                    
                                    <h5><i class="fas fa-store"></i> Al Comercio</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li><strong>Terminal POS:</strong> "Pago recibido ✅"</li>
                                        <li><strong>Dashboard:</strong> Actualización de ventas</li>
                                        <li><strong>Reporte diario:</strong> Consolidado automático</li>
                                    </ul>
                                </div>
                                
                                <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-history"></i> Trazabilidad Completa</h5>
                                    <p style="font-size: 0.85em; margin: 0;">Cada paso queda registrado para auditoría, análisis de fraude y soporte al cliente. Retención por 7 años según regulación.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-shield-alt"></i> Principios de Seguridad del Sistema</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(35, 53, 110, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-primary); font-style: italic; font-size: 1.0em;">
                            "Filosofía de seguridad que guía todo el proceso de validación"
                        </blockquote>

                        <div style="text-align: center; margin-top: 1.5rem;">
                            <p style="font-size: 1.1em; color: var(--uide-accent);">
                                <strong>Tres pilares fundamentales que garantizan la confianza del usuario</strong>
                            </p>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-exclamation-triangle"></i> Principio Fail-Safe</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(220, 53, 69, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #dc3545; font-style: italic; font-size: 1.0em;">
                            "Ante cualquier duda o error, el sistema rechaza la operación para mantener la consistencia"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-ban"></i> Principio Fundamental</h4>
                                <div style="background: rgba(220, 53, 69, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-balance-scale"></i> Jerarquía de Prioridades</h5>
                                    <ol style="font-size: 0.9em; margin: 0.5rem 0;">
                                        <li><strong>Consistencia</strong> > Velocidad</li>
                                        <li><strong>Seguridad</strong> > Conveniencia</li>
                                        <li><strong>Exactitud</strong> > Disponibilidad</li>
                                        <li><strong>Integridad</strong> > Rendimiento</li>
                                    </ol>
                                    
                                    <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                                        <p style="font-size: 0.85em; margin: 0; font-style: italic; text-align: center;">
                                            <strong>"Es mejor rechazar un pago válido que aprobar uno inválido"</strong>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-scenarios"></i> Escenarios de Aplicación</h4>
                                <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-question-circle"></i> Situaciones de Duda</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li><strong>Conexión inestable:</strong> Abortar si no hay confirmación</li>
                                        <li><strong>Datos ambiguos:</strong> Rechazar hasta aclarar</li>
                                        <li><strong>Timeout de respuesta:</strong> Rollback automático</li>
                                        <li><strong>Validación parcial:</strong> Esperar validación completa</li>
                                    </ul>
                                    
                                    <h5><i class="fas fa-shield-alt"></i> Beneficios</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li>Cero pérdidas por inconsistencias</li>
                                        <li>Confianza total del usuario</li>
                                        <li>Cumplimiento regulatorio garantizado</li>
                                        <li>Reducción de disputas y reclamos</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-lightbulb"></i> Implementación Práctica del Fail-Safe</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(233, 171, 33, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-accent); font-style: italic; font-size: 1.0em;">
                            "Mecanismos técnicos que garantizan la aplicación del principio fail-safe en cada transacción"
                        </blockquote>

                        <div style="text-align: center; margin-top: 1.5rem;">
                            <p style="font-size: 1.1em; color: var(--uide-accent);">
                                <strong>Tres pilares técnicos: Timeouts, Validaciones y Monitoreo</strong>
                            </p>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-clock"></i> Timeouts Inteligentes</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(233, 171, 33, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-accent); font-style: italic; font-size: 1.0em;">
                            "Límites de tiempo específicos para cada etapa de validación"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-stopwatch"></i> Tiempos Configurados por Etapa</h4>
                                <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-list-ol"></i> Límites por Validación</h5>
                                    <ul style="font-size: 0.9em; margin: 0.5rem 0;">
                                        <li><strong>Pre-validación:</strong> 2 segundos máximo</li>
                                        <li><strong>Validación de negocio:</strong> 5 segundos máximo</li>
                                        <li><strong>Validación de BD:</strong> 3 segundos máximo</li>
                                        <li><strong>Post-validación:</strong> 2 segundos máximo</li>
                                        <li><strong>Total por transacción:</strong> 12 segundos máximo</li>
                                    </ul>
                                    
                                    <h5><i class="fas fa-chart-pie"></i> Distribución del Tiempo</h5>
                                    <div style="background: #f8f9fa; padding: 0.8rem; border-radius: 6px; margin: 0.5rem 0;">
                                        <div style="font-size: 0.8em;">
                                            <div>🔍 Pre-validación: 17% (2s)</div>
                                            <div>🏢 Validación negocio: 42% (5s)</div>
                                            <div>💾 Validación BD: 25% (3s)</div>
                                            <div>✅ Post-validación: 16% (2s)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-exclamation-triangle"></i> Acción Automática al Timeout</h4>
                                <div style="background: rgba(220, 53, 69, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-code"></i> Código de Rollback</h5>
                                    <pre style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.7em;">
<code>-- Si timeout en cualquier etapa:
ROLLBACK;
UPDATE Pagos_QR SET estado = 'FALLIDO' 
WHERE payment_id = 'PAY_20241106_101_205_001';

INSERT INTO Auditoria_Transacciones 
(payment_id, accion, timestamp_accion)
VALUES ('PAY_20241106_101_205_001', 'TIMEOUT', NOW());

-- Mensaje al usuario:
"Transacción cancelada por timeout. 
Intente nuevamente en unos momentos."</code></pre>
                                    
                                    <h5><i class="fas fa-user-clock"></i> Experiencia del Usuario</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li><strong>0-8 segundos:</strong> "Procesando..."</li>
                                        <li><strong>8-12 segundos:</strong> "Validando seguridad..."</li>
                                        <li><strong>> 12 segundos:</strong> "Timeout - Intente nuevamente"</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-shield-alt"></i> Validaciones Redundantes</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(35, 53, 110, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-primary); font-style: italic; font-size: 1.0em;">
                            "Múltiples capas de validación para garantizar que ningún error pase desapercibido"
                        </blockquote>

                        <div style="text-align: center; margin-top: 1.5rem;">
                            <p style="font-size: 1.1em; color: var(--uide-accent);">
                                <strong>Arquitectura de defensa en profundidad con 4 capas independientes</strong>
                            </p>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-layer-group"></i> Arquitectura de 4 Capas</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(40, 167, 69, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #28a745; font-style: italic; font-size: 1.0em;">
                            "Cada capa tiene responsabilidades específicas y actúa independientemente"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-mobile-alt"></i> Capas Cliente</h4>
                                <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-1"></i> Capa 1: Aplicación Móvil</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li><strong>Validación offline:</strong> Formato, rangos básicos</li>
                                        <li><strong>Cache local:</strong> Límites conocidos</li>
                                        <li><strong>Prevención:</strong> Evita requests inválidos</li>
                                    </ul>
                                    
                                    <h5><i class="fas fa-2"></i> Capa 2: API Gateway</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li><strong>Autenticación:</strong> Token válido</li>
                                        <li><strong>Rate limiting:</strong> Máximo 10 req/min</li>
                                        <li><strong>Esquema JSON:</strong> Estructura correcta</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-server"></i> Capas Servidor</h4>
                                <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-3"></i> Capa 3: Microservicio</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li><strong>Lógica de negocio:</strong> Límites, horarios</li>
                                        <li><strong>Antifraude:</strong> Patrones sospechosos</li>
                                        <li><strong>Idempotencia:</strong> payment_id único</li>
                                    </ul>
                                    
                                    <h5><i class="fas fa-4"></i> Capa 4: Base de Datos</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li><strong>Constraints:</strong> CHECK, FK, UNIQUE</li>
                                        <li><strong>Triggers:</strong> Validaciones complejas</li>
                                        <li><strong>ACID:</strong> Garantías transaccionales</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-check-double"></i> Principio de Redundancia</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(145, 0, 72, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #91004a; font-style: italic; font-size: 1.0em;">
                            "Si una capa falla en detectar un error, las siguientes capas lo detectarán y rechazarán la transacción"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-shield-alt"></i> Filosofía de Defensa</h4>
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-route"></i> Flujo de Validación</h5>
                                    <div style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.7em;">
<code>App → API Gateway → Microservicio → Base de Datos
 ✓        ✓             ✓              ✓
 
Si cualquier ✗ → REJECT inmediato
Todas ✓ → COMMIT exitoso</code></div>
                                    
                                    <h5><i class="fas fa-lightning-bolt"></i> Rendimiento</h5>
                                    <p style="font-size: 0.85em; margin: 0.5rem 0;">Validaciones en paralelo cuando es posible. Tiempo total < 500ms en el 95% de casos.</p>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-percentage"></i> Efectividad Medida</h4>
                                <div style="background: rgba(145, 0, 72, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-chart-pie"></i> Cobertura por Capa</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li><strong>Capa 1:</strong> Detecta 60% de errores</li>
                                        <li><strong>Capa 2:</strong> Detecta 25% adicional</li>
                                        <li><strong>Capa 3:</strong> Detecta 10% adicional</li>
                                        <li><strong>Capa 4:</strong> Detecta 5% restante</li>
                                        <li><strong>Total:</strong> 99.99% de cobertura</li>
                                    </ul>
                                    
                                    <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 6px; margin-top: 1rem; text-align: center;">
                                        <p style="font-size: 0.9em; margin: 0; font-weight: bold;">
                                            <strong>99.99% de efectividad</strong><br>
                                            Solo 1 de cada 10,000 errores pasa desapercibido
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-robot"></i> Monitoreo y Alertas Automáticas</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(145, 0, 72, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #91004a; font-style: italic; font-size: 1.0em;">
                            "Sistema de monitoreo continuo que detecta problemas y escala recursos automáticamente"
                        </blockquote>

                        <div style="text-align: center; margin-top: 1.5rem;">
                            <p style="font-size: 1.1em; color: var(--uide-accent);">
                                <strong>Monitoreo proactivo con escalamiento y notificaciones automáticas</strong>
                            </p>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-chart-line"></i> Métricas y Umbrales de Alerta</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(233, 171, 33, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-accent); font-style: italic; font-size: 1.0em;">
                            "Indicadores clave con umbrales específicos para detección temprana de problemas"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-tachometer-alt"></i> Indicadores Clave</h4>
                                <div style="background: rgba(145, 0, 72, 0.1); padding: 1rem; border-radius: 8px;">
                                    <ul style="font-size: 0.9em; margin: 0.5rem 0;">
                                        <li><strong>Timeout rate:</strong> < 5% de transacciones</li>
                                        <li><strong>Tiempo de respuesta:</strong> P95 < 2 segundos</li>
                                        <li><strong>Error rate:</strong> < 0.1% de fallos del sistema</li>
                                        <li><strong>Throughput:</strong> > 1000 transacciones/minuto</li>
                                        <li><strong>Disponibilidad:</strong> > 99.9% uptime</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-bell"></i> Umbrales de Alerta</h4>
                                <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px;">
                                    <div style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.75em;">
<code>🟡 WARNING: timeout > 3%
🟠 CRITICAL: timeout > 5%
🔴 EMERGENCY: timeout > 10%

🟡 WARNING: response time > 3s
🟠 CRITICAL: response time > 5s
🔴 EMERGENCY: response time > 8s</code></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-cogs"></i> Acciones Automáticas del Sistema</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(40, 167, 69, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #28a745; font-style: italic; font-size: 1.0em;">
                            "Escalamiento de recursos y notificaciones escalonadas según severidad"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-expand-arrows-alt"></i> Escalamiento Automático</h4>
                                <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px;">
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li><strong>CPU > 70%:</strong> +2 instancias en 30s</li>
                                        <li><strong>Memory > 80%:</strong> +1 instancia en 60s</li>
                                        <li><strong>Queue > 100:</strong> +3 workers en 15s</li>
                                        <li><strong>DB connections > 90%:</strong> Pool expansion</li>
                                    </ul>
                                </div>
                                
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-history"></i> Recuperación Automática</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li><strong>Circuit breaker:</strong> Protege servicios degradados</li>
                                        <li><strong>Retry logic:</strong> Reintentos inteligentes</li>
                                        <li><strong>Graceful degradation:</strong> Funcionalidad reducida</li>
                                        <li><strong>Health checks:</strong> Verificación cada 30s</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-users"></i> Notificaciones Escalonadas</h4>
                                <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px;">
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li><strong>Slack:</strong> Equipo técnico (inmediato)</li>
                                        <li><strong>PagerDuty:</strong> Ingeniero de guardia</li>
                                        <li><strong>Email:</strong> Gerencia (crítico)</li>
                                        <li><strong>SMS:</strong> CTO (emergencia)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-cogs"></i> Mecanismos de Recuperación Automática</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(40, 167, 69, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #28a745; font-style: italic; font-size: 1.0em;">
                            "Sistemas automáticos que mantienen la operación segura ante fallos"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-redo"></i> Reintentos Inteligentes</h4>
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-chart-line"></i> Estrategia de Backoff</h5>
                                    <pre style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.7em;">
<code>-- Reintentos automáticos con delay exponencial
Intento 1: Inmediato
Intento 2: Esperar 1 segundo
Intento 3: Esperar 2 segundos  
Intento 4: Esperar 4 segundos
Intento 5: Esperar 8 segundos

-- Máximo 5 intentos en 15 segundos total
-- Si todos fallan → Fail-safe activado</code></pre>
                                    
                                    <h5><i class="fas fa-filter"></i> Criterios de Reintento</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li><strong>SÍ reintentar:</strong> Timeout de red, sobrecarga temporal</li>
                                        <li><strong>NO reintentar:</strong> Saldo insuficiente, datos inválidos</li>
                                        <li><strong>Idempotencia:</strong> Mismo payment_id evita duplicados</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-route"></i> Failover y Circuit Breaker</h4>
                                <div style="background: rgba(145, 0, 72, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-server"></i> Servidores de Respaldo</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li><strong>Servidor principal:</strong> Loja Data Center</li>
                                        <li><strong>Servidor secundario:</strong> Quito Data Center</li>
                                        <li><strong>Failover automático:</strong> < 30 segundos</li>
                                        <li><strong>Sincronización:</strong> Tiempo real</li>
                                    </ul>
                                    
                                    <h5><i class="fas fa-power-off"></i> Circuit Breaker</h5>
                                    <p style="font-size: 0.85em; margin: 0.5rem 0;">Si un servicio falla > 50% en 1 minuto:</p>
                                    <ol style="font-size: 0.8em; margin: 0.3rem 0;">
                                        <li>Abrir circuito (bloquear requests)</li>
                                        <li>Activar modo degradado</li>
                                        <li>Notificar usuarios del problema</li>
                                        <li>Intentar recuperación cada 30s</li>
                                    </ol>
                                </div>
                                
                                <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-user-shield"></i> Experiencia del Usuario</h5>
                                    <p style="font-size: 0.85em; margin: 0;">Usuario ve "Procesando..." durante reintentos. Solo recibe mensaje de error si todos los mecanismos fallan.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-eye"></i> Transparencia Total</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(40, 167, 69, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #28a745; font-style: italic; font-size: 1.0em;">
                            "El usuario siempre sabe exactamente por qué se rechazó una transacción"
                        </blockquote>

                        <div style="text-align: center; margin-top: 1.5rem;">
                            <p style="font-size: 1.1em; color: var(--uide-accent);">
                                <strong>Comunicación clara y multicanal para eliminar incertidumbre</strong>
                            </p>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-comment"></i> Mensajes Específicos y Claros</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(35, 53, 110, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-primary); font-style: italic; font-size: 1.0em;">
                            "Cada mensaje incluye información específica y acción sugerida"
                        </blockquote>

                        <div style="text-align: center; margin-top: 1.5rem;">
                            <p style="font-size: 1.1em; color: var(--uide-accent);">
                                <strong>Ejemplos reales de mensajes y principios de redacción</strong>
                            </p>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-mobile-alt"></i> Ejemplos de Mensajes Reales</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(40, 167, 69, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #28a745; font-style: italic; font-size: 1.0em;">
                            "Mensajes de éxito y error con información específica y contexto completo"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-check-circle"></i> Mensajes de Éxito</h4>
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px;">
                                    <div style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.8em; margin: 0.5rem 0;">
                                        <div style="margin: 0.3rem 0; color: #48bb78;">✅ <strong>Pago exitoso</strong></div>
                                        <div style="margin: 0.3rem 0;">"$2.50 pagado a Restaurante La Casona"</div>
                                        <div style="margin: 0.3rem 0;">"Nuevo saldo: $22.50"</div>
                                        <div style="margin: 0.3rem 0;">"Recibo: #PAY_20241106_101_205_001"</div>
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-times-circle"></i> Mensajes de Error</h4>
                                <div style="background: rgba(220, 53, 69, 0.1); padding: 1rem; border-radius: 8px;">
                                    <div style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.8em; margin: 0.5rem 0;">
                                        <div style="margin: 0.3rem 0; color: #f56565;">❌ <strong>Saldo insuficiente</strong></div>
                                        <div style="margin: 0.3rem 0;">"Saldo disponible: $25.00"</div>
                                        <div style="margin: 0.3rem 0;">"Monto solicitado: $30.00"</div>
                                        <div style="margin: 0.3rem 0;">"Sugerencia: Reducir monto o recargar cuenta"</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-language"></i> Principios de Redacción</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(233, 171, 33, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-accent); font-style: italic; font-size: 1.0em;">
                            "Características del lenguaje y localización para el contexto ecuatoriano"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-user-graduate"></i> Principios de Redacción</h4>
                                <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px;">
                                    <ul style="font-size: 0.9em; margin: 0.5rem 0;">
                                        <li><strong>Lenguaje claro:</strong> Sin tecnicismos ni códigos</li>
                                        <li><strong>Información específica:</strong> Valores exactos y contexto</li>
                                        <li><strong>Acción sugerida:</strong> Qué hacer para solucionarlo</li>
                                        <li><strong>Tono amigable:</strong> Ayudar, no culpar al usuario</li>
                                    </ul>
                                </div>
                                
                                <div style="background: rgba(145, 0, 72, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-exclamation-triangle"></i> Casos Especiales</h5>
                                    <div style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.75em;">
                                        <div style="margin: 0.3rem 0;">"Límite diario: $45.00 de $50.00 usado hoy"</div>
                                        <div style="margin: 0.3rem 0;">"Comercio cerrado. Horario: 6:00 AM - 10:00 PM"</div>
                                        <div style="margin: 0.3rem 0;">"Cuenta bloqueada temporalmente por seguridad"</div>
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-globe-americas"></i> Localización Ecuatoriana</h4>
                                <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px;">
                                    <ul style="font-size: 0.9em; margin: 0.5rem 0;">
                                        <li><strong>Moneda:</strong> Dólares americanos ($)</li>
                                        <li><strong>Horarios:</strong> Formato 24 horas</li>
                                        <li><strong>Fechas:</strong> DD/MM/YYYY</li>
                                        <li><strong>Idioma:</strong> Español neutro</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-heart"></i> Impacto en la Experiencia del Usuario</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(233, 171, 33, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-accent); font-style: italic; font-size: 1.0em;">
                            "Transparencia genera confianza, control y reduce la necesidad de soporte"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-brain"></i> Beneficios Psicológicos</h4>
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-shield-alt"></i> Confianza</h5>
                                    <p style="font-size: 0.85em; margin: 0.5rem 0;">Usuario entiende exactamente qué pasó con su dinero. No hay "cajas negras" ni misterios.</p>
                                    
                                    <h5><i class="fas fa-hand-paper"></i> Control</h5>
                                    <p style="font-size: 0.85em; margin: 0.5rem 0;">Sabe cómo solucionar el problema por sí mismo. Información específica permite acción directa.</p>
                                    
                                    <h5><i class="fas fa-smile"></i> Tranquilidad</h5>
                                    <p style="font-size: 0.85em; margin: 0.5rem 0;">Elimina ansiedad e incertidumbre. Usuario sabe que el sistema funciona correctamente.</p>
                                    
                                    <h5><i class="fas fa-graduation-cap"></i> Educación</h5>
                                    <p style="font-size: 0.85em; margin: 0.5rem 0;">Aprende sobre límites, horarios y reglas del sistema. Mejora su uso futuro.</p>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-chart-line"></i> Métricas de Impacto</h4>
                                <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-phone"></i> Reducción de Soporte</h5>
                                    <div style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.75em; margin: 0.5rem 0;">
                                        <div style="margin: 0.3rem 0;">📞 Llamadas al call center: <strong>-70%</strong></div>
                                        <div style="margin: 0.3rem 0;">⏱️ Tiempo promedio de llamada: <strong>-50%</strong></div>
                                        <div style="margin: 0.3rem 0;">😊 Satisfacción del usuario: <strong>+85%</strong></div>
                                        <div style="margin: 0.3rem 0;">🔄 Reintentos exitosos: <strong>+60%</strong></div>
                                    </div>
                                    
                                    <h5><i class="fas fa-users"></i> Comportamiento del Usuario</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li><strong>Autoservicio:</strong> 90% resuelve problemas solo</li>
                                        <li><strong>Confianza:</strong> 95% confía en el sistema</li>
                                        <li><strong>Adopción:</strong> +40% uso de funciones avanzadas</li>
                                        <li><strong>Retención:</strong> +25% usuarios activos mensuales</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-globe"></i> Comunicación Multicanal</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(145, 0, 72, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #91004a; font-style: italic; font-size: 1.0em;">
                            "Múltiples canales garantizan que el usuario reciba la información"
                        </blockquote>

                        <div style="text-align: center; margin-top: 1.5rem;">
                            <p style="font-size: 1.1em; color: var(--uide-accent);">
                                <strong>Canales primarios y secundarios con sincronización en tiempo real</strong>
                            </p>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-mobile-alt"></i> Canales Primarios</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(35, 53, 110, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-primary); font-style: italic; font-size: 1.0em;">
                            "App móvil y SMS como canales principales de comunicación inmediata"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-bell"></i> App Móvil (Principal)</h4>
                                <div style="background: rgba(145, 0, 72, 0.1); padding: 1rem; border-radius: 8px;">
                                    <ul style="font-size: 0.9em; margin: 0.5rem 0;">
                                        <li><strong>Push notification:</strong> Inmediata (< 1 segundo)</li>
                                        <li><strong>In-app message:</strong> Detalle completo</li>
                                        <li><strong>Historial:</strong> Todas las transacciones</li>
                                        <li><strong>Estado en tiempo real:</strong> Saldo actualizado</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-sms"></i> SMS (Respaldo)</h4>
                                <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px;">
                                    <ul style="font-size: 0.9em; margin: 0.5rem 0;">
                                        <li><strong>Confirmación:</strong> Pagos > $10.00</li>
                                        <li><strong>Alertas de seguridad:</strong> Bloqueos temporales</li>
                                        <li><strong>Código único:</strong> Para disputas</li>
                                        <li><strong>Funciona sin internet:</strong> Cobertura total</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-desktop"></i> Canales Secundarios</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(40, 167, 69, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #28a745; font-style: italic; font-size: 1.0em;">
                            "Email y terminal POS para documentación y confirmación en comercios"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-envelope"></i> Email (Opcional)</h4>
                                <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px;">
                                    <ul style="font-size: 0.9em; margin: 0.5rem 0;">
                                        <li><strong>Recibo detallado:</strong> PDF adjunto</li>
                                        <li><strong>Resumen mensual:</strong> Todas las transacciones</li>
                                        <li><strong>Configuración:</strong> Usuario decide si recibir</li>
                                        <li><strong>Archivo permanente:</strong> Para contabilidad</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-cash-register"></i> Terminal POS (Comercio)</h4>
                                <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px;">
                                    <ul style="font-size: 0.9em; margin: 0.5rem 0;">
                                        <li><strong>Confirmación visual:</strong> "Pago recibido ✅"</li>
                                        <li><strong>Sonido distintivo:</strong> Pago exitoso</li>
                                        <li><strong>Recibo impreso:</strong> Para el cliente</li>
                                        <li><strong>Dashboard web:</strong> Ventas en tiempo real</li>
                                    </ul>
                                </div>
                                
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-sync"></i> Sincronización</h5>
                                    <p style="font-size: 0.85em; margin: 0;">Todos los canales muestran información consistente. Actualización en tiempo real entre dispositivos.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-history"></i> Trazabilidad Completa</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(145, 0, 72, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #91004a; font-style: italic; font-size: 1.0em;">
                            "Cada validación queda registrada para auditoría, análisis y mejora continua"
                        </blockquote>

                        <div style="text-align: center; margin-top: 1.5rem;">
                            <p style="font-size: 1.1em; color: var(--uide-accent);">
                                <strong>Registro detallado con múltiples usos: auditoría, fraude, soporte y mejora</strong>
                            </p>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-database"></i> Registro Detallado de Transacciones</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(35, 53, 110, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-primary); font-style: italic; font-size: 1.0em;">
                            "Captura completa de información con precisión de microsegundos"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-list"></i> Información Capturada</h4>
                                <div style="background: rgba(145, 0, 72, 0.1); padding: 1rem; border-radius: 8px;">
                                    <ul style="font-size: 0.9em; margin: 0.5rem 0;">
                                        <li><strong>Timestamp:</strong> Fecha y hora exacta (microsegundos)</li>
                                        <li><strong>Usuario:</strong> ID del cliente y dispositivo</li>
                                        <li><strong>Ubicación:</strong> GPS y dirección IP</li>
                                        <li><strong>Operación:</strong> Tipo de validación ejecutada</li>
                                        <li><strong>Resultado:</strong> Éxito, fallo y razón específica</li>
                                        <li><strong>Valores:</strong> Datos antes y después</li>
                                        <li><strong>Contexto:</strong> Estado del sistema en ese momento</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-code"></i> Ejemplo de Log Real</h4>
                                <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px;">
                                    <pre style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.7em;">
<code>2024-11-06 14:30:15.123456 [INFO] 
payment_id: PAY_20241106_101_205_001
user_id: 101 (María José Rodríguez)
device: iPhone 15 Pro (iOS 17.1)
location: -4.0039, -79.2041 (Loja, Ecuador)
validation: PRE_CHECK_BALANCE
before: saldo=25.00, limite_diario=50.00, usado_hoy=22.50
after: saldo=22.50, limite_diario=50.00, usado_hoy=25.00
result: SUCCESS
duration: 45ms</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-chart-line"></i> Usos Estratégicos del Registro</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(40, 167, 69, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #28a745; font-style: italic; font-size: 1.0em;">
                            "Datos de trazabilidad para cumplimiento, seguridad y optimización"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-balance-scale"></i> Auditoría Regulatoria</h4>
                                <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px;">
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li>Cumplimiento con Superintendencia de Bancos</li>
                                        <li>Reportes automáticos de transacciones > $1000</li>
                                        <li>Evidencia para investigaciones</li>
                                        <li>Retención por 7 años según ley</li>
                                    </ul>
                                </div>
                                
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-headset"></i> Soporte al Cliente</h5>
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li>Resolución rápida de disputas</li>
                                        <li>Reconstrucción de transacciones</li>
                                        <li>Evidencia para reclamos</li>
                                        <li>Análisis de problemas recurrentes</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-shield-alt"></i> Análisis de Fraude</h4>
                                <div style="background: rgba(145, 0, 72, 0.1); padding: 1rem; border-radius: 8px;">
                                    <ul style="font-size: 0.85em; margin: 0.5rem 0;">
                                        <li>Detección de patrones sospechosos</li>
                                        <li>Machine learning para prevención</li>
                                        <li>Investigación de incidentes</li>
                                        <li>Mejora de algoritmos de detección</li>
                                    </ul>
                                </div>
                                
                                <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-cogs"></i> Mejora Continua</h5>
                                    <p style="font-size: 0.85em; margin: 0;">Análisis de logs permite optimizar validaciones, reducir falsos positivos y mejorar experiencia del usuario.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-check-circle"></i> Garantía Final del Sistema</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(233, 171, 33, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-accent); font-style: italic; font-size: 1.0em;">
                            "Integración de todos los principios en una garantía absoluta de seguridad"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div style="text-align: center; margin: 2rem 0;">
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 2rem; border-radius: 12px; border: 3px solid #28a745;">
                                    <h4 style="color: #28a745; margin-bottom: 1rem;"><i class="fas fa-shield-alt"></i> Compromiso del Sistema</h4>
                                    <p style="font-size: 1.1em; margin: 1rem 0; font-weight: bold;">
                                        El sistema aplica <strong>todas las reglas</strong> antes de COMMIT.<br>
                                        Si alguna falla, aborta la transacción completa<br>
                                        y muestra mensaje específico al usuario.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-lock"></i> Garantías Técnicas</h4>
                                <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px;">
                                    <ul style="font-size: 0.9em; margin: 0.5rem 0;">
                                        <li><strong><i class="fas fa-atom"></i> Atomicidad:</strong> Todo o nada, sin estados intermedios</li>
                                        <li><strong><i class="fas fa-check-circle"></i> Consistencia:</strong> Todas las reglas aplicadas siempre</li>
                                        <li><strong><i class="fas fa-user-secret"></i> Aislamiento:</strong> Transacciones independientes</li>
                                        <li><strong><i class="fas fa-save"></i> Durabilidad:</strong> Cambios permanentes tras COMMIT</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-heart"></i> Garantías al Usuario</h4>
                                <div style="background: rgba(145, 0, 72, 0.1); padding: 1rem; border-radius: 8px;">
                                    <ul style="font-size: 0.9em; margin: 0.5rem 0;">
                                        <li><strong><i class="fas fa-shield-alt"></i> Seguridad:</strong> Nunca perderá dinero por fallas del sistema</li>
                                        <li><strong><i class="fas fa-eye"></i> Transparencia:</strong> Siempre sabrá qué pasó con su transacción</li>
                                        <li><strong><i class="fas fa-history"></i> Trazabilidad:</strong> Registro completo para cualquier consulta</li>
                                        <li><strong><i class="fas fa-balance-scale"></i> Justicia:</strong> Mismo tratamiento para todos los usuarios</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div style="background: rgba(233, 171, 33, 0.1); padding: 1.5rem; border-radius: 8px; margin-top: 1.5rem; text-align: center;">
                            <h4><i class="fas fa-award"></i> Certificación de Confianza</h4>
                            <p style="font-size: 1.0em; margin: 0.5rem 0;">
                                <strong>Sistema certificado PCI-DSS</strong> para manejo seguro de pagos<br>
                                <strong>Cumplimiento ISO 27001</strong> para gestión de seguridad de información<br>
                                <strong>Aprobado por Superintendencia de Bancos</strong> del Ecuador
                            </p>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-user-secret"></i> Aislamiento en Pagos Concurrentes</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(233, 171, 33, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-primary); font-style: italic; font-size: 1.0em;">
                            "Evitar 'lecturas no repetibles' en consulta de saldo durante pagos concurrentes"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-mobile-alt"></i> Problema: Consulta de Saldo Durante Pago</h4>
                                <div style="background: rgba(220, 53, 69, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-clock"></i> Sin Aislamiento Adecuado</h5>
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.7em;">
                                        <thead>
                                            <tr style="background: rgba(35, 53, 110, 0.1);">
                                                <th style="padding: 0.3rem; border: 1px solid #ddd;">Tiempo</th>
                                                <th style="padding: 0.3rem; border: 1px solid #ddd;">María José (App)</th>
                                                <th style="padding: 0.3rem; border: 1px solid #ddd;">Joseph (Pago QR)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="padding: 0.3rem; border: 1px solid #ddd;">T1</td>
                                                <td style="padding: 0.3rem; border: 1px solid #ddd;">Consulta saldo</td>
                                                <td style="padding: 0.3rem; border: 1px solid #ddd;">-</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 0.3rem; border: 1px solid #ddd;">T2</td>
                                                <td style="padding: 0.3rem; border: 1px solid #ddd;">Ve: $25.00</td>
                                                <td style="padding: 0.3rem; border: 1px solid #ddd;">Paga $2.50 almuerzo</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 0.3rem; border: 1px solid #ddd;">T3</td>
                                                <td style="padding: 0.3rem; border: 1px solid #ddd;">Consulta saldo otra vez</td>
                                                <td style="padding: 0.3rem; border: 1px solid #ddd;">COMMIT</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 0.3rem; border: 1px solid #ddd;">T4</td>
                                                <td style="padding: 0.3rem; border: 1px solid #ddd;">Ve: $22.50 <i class="fas fa-frown text-warning"></i></td>
                                                <td style="padding: 0.3rem; border: 1px solid #ddd;">-</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <p style="font-size: 0.8em; margin: 0.5rem 0;"><strong>Problema:</strong> María José ve dos saldos diferentes en la misma sesión!</p>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-lock"></i> Niveles de Aislamiento en Sistemas de Pago</h4>
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.8em;">
                                    <thead>
                                        <tr style="background: rgba(35, 53, 110, 0.1);">
                                            <th style="padding: 0.4rem; border: 1px solid #ddd;">Nivel</th>
                                            <th style="padding: 0.4rem; border: 1px solid #ddd;">Uso Típico</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td style="padding: 0.4rem; border: 1px solid #ddd;"><strong>SERIALIZABLE</strong></td>
                                            <td style="padding: 0.4rem; border: 1px solid #ddd;">Reportes contables críticos</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 0.4rem; border: 1px solid #ddd;"><strong>REPEATABLE READ</strong></td>
                                            <td style="padding: 0.4rem; border: 1px solid #ddd;">Consultas de saldo en app</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 0.4rem; border: 1px solid #ddd;"><strong>READ COMMITTED</strong></td>
                                            <td style="padding: 0.4rem; border: 1px solid #ddd;">Pagos QR normales</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 0.4rem; border: 1px solid #ddd;"><strong>READ UNCOMMITTED</strong></td>
                                            <td style="padding: 0.4rem; border: 1px solid #ddd;"><i class="fas fa-times text-danger"></i> Nunca en sistemas financieros</td>
                                        </tr>
                                    </tbody>
                                </table>
                                
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-balance-scale"></i> Decisiones Técnicas</h5>
                                    <p style="font-size: 0.8em; margin: 0;"><strong>Consultas de saldo:</strong> REPEATABLE READ<br><strong>Pagos QR:</strong> READ COMMITTED<br><strong>Reportes:</strong> SERIALIZABLE</p>
                                </div>

                                <!-- Simulador de Niveles de Aislamiento -->
                                <div style="background: rgba(233, 171, 33, 0.1); padding: 1.5rem; border-radius: 8px; margin-top: 1rem; border: 2px solid var(--uide-accent);">
                                    <h5 style="text-align: center; margin-bottom: 1rem;"><i class="fas fa-eye"></i> Simulador: Niveles de Aislamiento</h5>
                                    
                                    <div id="isolation-simulator">
                                        <div style="margin-bottom: 1rem; text-align: center;">
                                            <label style="margin-right: 1rem; font-weight: bold;">Nivel de Aislamiento:</label>
                                            <select id="isolation-level" onchange="updateIsolationDemo()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
                                                <option value="read-uncommitted">READ UNCOMMITTED</option>
                                                <option value="read-committed" selected>READ COMMITTED</option>
                                                <option value="repeatable-read">REPEATABLE READ</option>
                                                <option value="serializable">SERIALIZABLE</option>
                                            </select>
                                        </div>

                                        <div style="display: flex; justify-content: space-around; margin: 1rem 0; flex-wrap: wrap;">
                                            <!-- Sesión María José -->
                                            <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; border: 2px solid #28a745; margin: 0.5rem; flex: 1; min-width: 250px;">
                                                <h6><i class="fas fa-mobile-alt"></i> María José (Consulta Saldo)</h6>
                                                <div id="maria-isolation-actions" style="margin-top: 0.5rem;">
                                                    <button onclick="mariaReadBalance()" style="background: #28a745; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; margin: 0.2rem; font-size: 0.8em;">
                                                        📱 Consultar Saldo
                                                    </button>
                                                </div>
                                                <div id="maria-balance-display" style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; font-family: monospace; font-size: 0.9em;">
                                                    Saldo: $25.00
                                                </div>
                                            </div>

                                            <!-- Sesión Joseph -->
                                            <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px; border: 2px solid #007bff; margin: 0.5rem; flex: 1; min-width: 250px;">
                                                <h6><i class="fas fa-qrcode"></i> Joseph (Pago QR)</h6>
                                                <div id="joseph-isolation-actions" style="margin-top: 0.5rem;">
                                                    <button onclick="josephMakePayment()" style="background: #007bff; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; margin: 0.2rem; font-size: 0.8em;">
                                                        <i class="fas fa-credit-card"></i> Pagar $2.50
                                                    </button>
                                                    <button onclick="josephCommit()" style="background: #ffc107; color: black; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; margin: 0.2rem; font-size: 0.8em;" disabled>
                                                        <i class="fas fa-check"></i> COMMIT
                                                    </button>
                                                </div>
                                                <div id="joseph-status-display" style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; font-family: monospace; font-size: 0.9em;">
                                                    Estado: Inactivo
                                                </div>
                                            </div>
                                        </div>

                                        <div id="isolation-explanation" style="background: rgba(255,255,255,0.8); padding: 1rem; border-radius: 8px; margin: 1rem 0; font-size: 0.85em;">
                                            <strong>READ COMMITTED:</strong> María José solo ve cambios confirmados. No verá el pago de Joseph hasta que haga COMMIT.
                                        </div>

                                        <div style="text-align: center; margin-top: 1rem;">
                                            <button onclick="resetIsolationDemo()" style="background: #6c757d; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                                                <i class="fas fa-redo"></i> Reiniciar Demo
                                            </button>
                                        </div>
                                    </div>
                                </div>""
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-save"></i> Durabilidad en Sistemas de Pago</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(145, 0, 72, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-primary); font-style: italic; font-size: 1.0em;">
                            "Tras COMMIT, el registro persiste y respalda la confirmación que ven cliente y comercio"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-server"></i> Escenario: Falla de Infraestructura</h4>
                                <div style="background: rgba(220, 53, 69, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-bolt"></i> Corte de Energía en Data Center</h5>
                                    <pre style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.7em;">
<code>-- 14:30:15 - María José paga $2.50 almuerzo
START TRANSACTION;
UPDATE Cuentas SET saldo = saldo - 2.50 WHERE id = 101;
UPDATE Cuentas SET saldo = saldo + 2.50 WHERE id = 205;
INSERT INTO Pagos_QR (payment_id, cliente_id, comercio_id, monto, fecha, estado) 
VALUES ('PAY_20251106_101_205_003', 101, 205, 2.50, NOW(), 'CONFIRMADO');
COMMIT; -- [OK] Confirmado a las 14:30:16

-- 14:30:17 - [!] CORTE DE ENERGÍA [!]
-- Servidores se apagan, memoria volátil perdida

-- 14:45:00 - Sistema de respaldo activado
-- ¿Se perdió el pago de María José?</code></pre>
                                </div>
                                
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-check-circle"></i> Recuperación Exitosa</h5>
                                    <p style="font-size: 0.8em; margin: 0;">El sistema de respaldo tiene <strong>registro permanente</strong> hasta 14:30:16. El pago de María José está <strong>garantizado</strong> y el recibo sigue siendo válido.</p>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-shield-alt"></i> Mecanismos de Durabilidad</h4>
                                <ul style="font-size: 0.9em;">
                                    <li><strong>Almacenamiento persistente</strong>: Datos en disco no volátil</li>
                                    <li><strong>Replicación</strong>: Múltiples copias de seguridad</li>
                                    <li><strong>Transacciones confirmadas</strong>: Cambios permanentes</li>
                                    <li><strong>Integridad de datos</strong>: Verificación de consistencia</li>
                                </ul>
                                
                                <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-clock"></i> Garantías de Tiempo</h5>
                                    <p style="font-size: 0.8em; margin: 0;">Los sistemas financieros deben garantizar que las transacciones confirmadas <strong>persistan permanentemente</strong>, incluso ante fallos de hardware o software.</p>
                                </div>
                                
                                <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-balance-scale"></i> Regulación Financiera</h5>
                                    <p style="font-size: 0.8em; margin: 0;">Los reguladores bancarios <strong>exigen</strong> durabilidad. Los sistemas de pago deben cumplir estándares internacionales de recuperación.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </section>

            <!-- Control de Concurrencia -->
            <section data-transition="convex">
                <h2><i class="fas fa-lock"></i> Control de Concurrencia</h2>

                <section>
                    <h3>Necesidad del Control de Concurrencia</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(40, 167, 69, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-primary); font-style: italic; font-size: 1.0em;">
                            "Hora pico: múltiples clientes pagan al mismo comercio simultáneamente"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-clock"></i> Escenario: Hora de Almuerzo</h4>
                                <ul style="font-size: 0.9em;">
                                    <li><strong>12:30 PM</strong>: Pico de pagos en restaurantes</li>
                                    <li><strong>Múltiples estudiantes</strong> pagan simultáneamente</li>
                                    <li><strong>Mismo comercio</strong>: La cafetería</li>
                                    <li><strong>Contención alta</strong>: Cuenta del comercio es hotspot</li>
                                </ul>
                                
                                <div style="background: rgba(220, 53, 69, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-exclamation-triangle"></i> Sin Control</h5>
                                    <p style="font-size: 0.8em; margin: 0;">Pagos simultáneos podrían generar saldos incorrectos, pagos duplicados, o pérdida de transacciones.</p>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-check-double"></i> Criterio de Correctitud</h4>
                                <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px;">
                                    <p style="font-size: 0.9em; margin: 0;">
                                        <strong>Serializabilidad</strong>: Los pagos concurrentes deben producir el mismo resultado que si se procesaran secuencialmente
                                    </p>
                                </div>

                                <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-balance-scale"></i> Trade-off</h5>
                                    <p style="font-size: 0.8em; margin: 0;"><strong>Concurrencia vs. Consistencia</strong><br>Mayor paralelismo puede comprometer la exactitud de los datos.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3>Enfoques de Control de Concurrencia</h3>
                    <div class="concept-box">
                        <div class="r-hstack">
                            <div class="column">
                                <div style="background: rgba(233, 171, 33, 0.1); padding: 1.5rem; border-radius: 8px;">
                                    <h4><i class="fas fa-shield-alt"></i> Control Pesimista (Bloqueos)</h4>
                                    <ul style="font-size: 0.9em;">
                                        <li><strong>Ideal cuando hay alta contención</strong> (mismo comercio/QR)</li>
                                        <li><strong>Bloqueos preventivos</strong> antes del acceso</li>
                                        <li><strong>Garantiza consistencia</strong> a costa de concurrencia</li>
                                    </ul>
                                    <div style="background: rgba(255,255,255,0.7); padding: 0.8rem; border-radius: 6px; margin-top: 1rem;">
                                        <p style="font-size: 0.8em; margin: 0;"><strong>Uso:</strong> Pagos a comercios populares en hora pico</p>
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <div style="background: rgba(145, 0, 72, 0.1); padding: 1.5rem; border-radius: 8px;">
                                    <h4><i class="fas fa-rocket"></i> Control Optimista (Validación)</h4>
                                    <ul style="font-size: 0.9em;">
                                        <li><strong>Útil en picos moderados</strong> y lecturas frecuentes</li>
                                        <li><strong>Validación al confirmar</strong> la transacción</li>
                                        <li><strong>Aborta si detecta conflicto</strong> al hacer COMMIT</li>
                                    </ul>
                                    <div style="background: rgba(255,255,255,0.7); padding: 0.8rem; border-radius: 6px; margin-top: 1rem;">
                                        <p style="font-size: 0.8em; margin: 0;"><strong>Uso:</strong> Consultas de saldo, validaciones de límites</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 1rem;">
                            <h4><i class="fas fa-mobile-alt"></i> Enfoque Híbrido en Móviles</h4>
                            <p style="font-size: 0.9em; background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px;">
                                <strong>Combinar:</strong> Bloqueos finos + validaciones ligeras (límites, antifraude, idempotencia)
                            </p>
                        </div>
                    </div>
                </section>
            </section>

            <!-- Técnicas de Bloqueo -->
            <section data-transition="convex">
                <h2><i class="fas fa-key"></i> Técnicas de Bloqueo</h2>

                <section>
                    <h3>Conceptos Fundamentales de Bloqueo</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(233, 171, 33, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-primary); font-style: italic; font-size: 1.0em;">
                            "Controlar acceso a cuentas de clientes y comercios durante pagos concurrentes"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-shield-alt"></i> Propósito en Pagos QR</h4>
                                <ul style="font-size: 0.9em;">
                                    <li><strong>Prevenir sobregiros</strong> en cuentas de clientes</li>
                                    <li><strong>Evitar pérdida de pagos</strong> en cuentas de comercios</li>
                                    <li><strong>Garantizar atomicidad</strong> de débito-crédito</li>
                                    <li><strong>Imposición automática</strong> por el SGBD</li>
                                </ul>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-layer-group"></i> Granularidad en Sistemas de Pago</h4>
                                <div style="background: rgba(145, 0, 72, 0.1); padding: 1rem; border-radius: 8px;">
                                    <p style="font-size: 0.9em; margin: 0;">
                                        <strong>Fila de cuenta del cliente</strong>: Bloqueo de débito<br>
                                        <strong>Fila de cuenta del comercio</strong>: Hotspot potencial
                                    </p>
                                </div>

                                <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-lightbulb"></i> Consideraciones de Diseño</h5>
                                    <ul style="font-size: 0.8em; margin: 0.5rem 0;">
                                        <li>Orden de bloqueo consistente</li>
                                        <li>Minimizar tiempo de bloqueo</li>
                                        <li>Gestión de hotspots</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3>Granularidad de Bloqueo</h3>
                    <div class="concept-box">
                        <div class="r-hstack">
                            <div class="column">
                                <h4><i class="fas fa-layer-group"></i> Niveles Principales</h4>
                                <ul style="font-size: 0.9em;">
                                    <li><strong>Fila:</strong> Máxima concurrencia, mayor overhead</li>
                                    <li><strong>Tabla:</strong> Menor concurrencia, menor overhead</li>
                                </ul>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-balance-scale"></i> Trade-off</h4>
                                <p style="font-size: 0.9em;">
                                    <strong>Granularidad fina:</strong> Más concurrencia, más complejidad<br>
                                    <strong>Granularidad gruesa:</strong> Menos concurrencia, más simple
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3>Modos de Bloqueo en Pagos QR</h3>
                    <div class="concept-box">
                        <table style="width: 100%; border-collapse: collapse; margin: 1rem 0;">
                            <thead>
                                <tr style="background: rgba(35, 53, 110, 0.1);">
                                    <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: left;">Tipo</th>
                                    <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: left;">Uso en Pagos QR</th>
                                    <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: left;">Ejemplo</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 0.5rem; border: 1px solid #ddd;"><strong>Compartido (S)</strong></td>
                                    <td style="padding: 0.5rem; border: 1px solid #ddd;">Lecturas de saldo concurrentes</td>
                                    <td style="padding: 0.5rem; border: 1px solid #ddd;">Consultar saldo en app</td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.5rem; border: 1px solid #ddd;"><strong>Exclusivo (X)</strong></td>
                                    <td style="padding: 0.5rem; border: 1px solid #ddd;">Débito/crédito de cuentas</td>
                                    <td style="padding: 0.5rem; border: 1px solid #ddd;">Procesar pago QR</td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.5rem; border: 1px solid #ddd;"><strong>Actualización (U)</strong></td>
                                    <td style="padding: 0.5rem; border: 1px solid #ddd;">Leer-para-escribir</td>
                                    <td style="padding: 0.5rem; border: 1px solid #ddd;">Verificar saldo antes de débito</td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.5rem; border: 1px solid #ddd;"><strong>Intención (IS/IX)</strong></td>
                                    <td style="padding: 0.5rem; border: 1px solid #ddd;">Jerarquía de bloqueo</td>
                                    <td style="padding: 0.5rem; border: 1px solid #ddd;">Bloquear tabla antes que fila</td>
                                </tr>
                            </tbody>
                        </table>

                        <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <h5><i class="fas fa-crown"></i> Regla de Oro</h5>
                            <p style="font-size: 0.9em; margin: 0;">
                                <strong>Minimiza tiempo en X</strong>; confirma rápido; evita lógicas largas dentro de la transacción
                            </p>
                        </div>
                    </div>
                </section>

                <section>
                    <h3>Protocolo de Bloqueo en Dos Fases (2PL)</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(145, 0, 72, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--uide-primary); font-style: italic; font-size: 1.0em;">
                            "Expansión: tomas los bloqueos (cliente → comercio). Contracción: liberas tras COMMIT"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h4><i class="fas fa-expand-arrows-alt"></i> Fase de Expansión</h4>
                                    <ul style="font-size: 0.9em;">
                                        <li><strong>Adquirir bloqueos</strong> según se necesiten</li>
                                        <li><strong>NO liberar</strong> ningún bloqueo existente</li>
                                        <li><strong>Orden:</strong> Cliente primero, comercio después</li>
                                    </ul>
                                    <div style="background: rgba(255,255,255,0.7); padding: 0.8rem; border-radius: 6px; margin-top: 1rem;">
                                        <code style="font-size: 0.8em;">LOCK cuenta_cliente; LOCK cuenta_comercio;</code>
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h4><i class="fas fa-compress-arrows-alt"></i> Fase de Contracción</h4>
                                    <ul style="font-size: 0.9em;">
                                        <li><strong>Liberar bloqueos</strong> tras COMMIT</li>
                                        <li><strong>NO adquirir</strong> nuevos bloqueos</li>
                                        <li><strong>Liberación automática</strong> al finalizar</li>
                                    </ul>
                                    <div style="background: rgba(255,255,255,0.7); padding: 0.8rem; border-radius: 6px; margin-top: 1rem;">
                                        <code style="font-size: 0.8em;">COMMIT; -- Libera todos los locks</code>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
                </section>

                <section>
                    <h3><i class="fas fa-exclamation-triangle"></i> Problema: Interbloqueo (Deadlock)</h3>
                    <div class="concept-box">
                        <blockquote style="background: rgba(220, 53, 69, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #dc3545; font-style: italic; font-size: 1.0em;">
                            "Situación en la que un grupo de transacciones no pueden continuar porque están esperando unas a las otras"
                        </blockquote>

                        <div class="r-hstack" style="margin-top: 1.5rem;">
                            <div class="column">
                                <h4><i class="fas fa-university"></i> Caso Real: Transferencias Cruzadas</h4>
                                <div style="background: rgba(220, 53, 69, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-exchange-alt"></i> Viernes de Quincena - 17:00 hrs</h5>
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.7em;">
                                        <thead>
                                            <tr style="background: rgba(35, 53, 110, 0.1);">
                                                <th style="padding: 0.3rem; border: 1px solid #ddd;">María José → Joseph ($15.00)</th>
                                                <th style="padding: 0.3rem; border: 1px solid #ddd;">Joseph → María José ($10.00)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="padding: 0.3rem; border: 1px solid #ddd;">
                                                    <code>LOCK Cuenta_MaríaJosé</code> <i class="fas fa-check text-success"></i>
                                                </td>
                                                <td style="padding: 0.3rem; border: 1px solid #ddd;">
                                                    <code>LOCK Cuenta_Joseph</code> <i class="fas fa-check text-success"></i>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 0.3rem; border: 1px solid #ddd;">
                                                    <code>LOCK Cuenta_Joseph</code> <i class="fas fa-clock text-warning"></i>
                                                </td>
                                                <td style="padding: 0.3rem; border: 1px solid #ddd;">
                                                    <code>LOCK Cuenta_MaríaJosé</code> <i class="fas fa-clock text-warning"></i>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 0.3rem; border: 1px solid #ddd; color: #dc3545;">
                                                    <strong>Esperando...</strong>
                                                </td>
                                                <td style="padding: 0.3rem; border: 1px solid #ddd; color: #dc3545;">
                                                    <strong>Esperando...</strong>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <p style="font-size: 0.8em; margin: 0.5rem 0; color: #dc3545;"><strong><i class="fas fa-exclamation-triangle"></i> DEADLOCK:</strong> Ambas transacciones se bloquean mutuamente</p>
                                </div>
                                
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-robot"></i> Resolución Automática del SGBD</h5>
                                    <pre style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.7em;">
<code>-- El SGBD detecta el deadlock en 2 segundos
-- Elige una "víctima" (transacción más joven)
-- Hace ROLLBACK de la transacción de Joseph
-- María José completa su transferencia
-- Joseph reintenta automáticamente</code></pre>
                                </div>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-tools"></i> Estrategias de Prevención</h4>
                                
                                <div style="background: rgba(35, 53, 110, 0.1); padding: 1rem; border-radius: 8px;">
                                    <h5><i class="fas fa-sort-numeric-up"></i> 1. Orden Consistente</h5>
                                    <pre style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.7em;">
<code>-- Siempre bloquear cuentas por ID ascendente
IF cuenta_origen < cuenta_destino THEN
  LOCK cuenta_origen, cuenta_destino
ELSE
  LOCK cuenta_destino, cuenta_origen
END IF</code></pre>
                                </div>
                                
                                <div style="background: rgba(233, 171, 33, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-clock"></i> 2. Timeout Inteligente</h5>
                                    <ul style="font-size: 0.8em; margin: 0.5rem 0;">
                                        <li><strong>Timeout:</strong> 5 segundos máximo</li>
                                        <li><strong>Retry automático:</strong> Con backoff exponencial</li>
                                        <li><strong>Alertas:</strong> Si >10 deadlocks/minuto</li>
                                    </ul>
                                </div>
                                
                                <div style="background: rgba(145, 0, 72, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <h5><i class="fas fa-chart-line"></i> Monitoreo del Sistema</h5>
                                    <ul style="font-size: 0.8em; margin: 0.5rem 0;">
                                        <li><strong>Deadlocks/hora:</strong> < 50 (normal)</li>
                                        <li><strong>Horario pico:</strong> 17:00-19:00 (quincenas)</li>
                                        <li><strong>Impacto:</strong> < 0.1% de transacciones</li>
                                    </ul>
                                </div>
                            </div>
                        </div>


                    </div>
                </section>
            </section>



            <!-- Aplicación Práctica -->
            <section data-transition="convex">
                <h2><i class="fas fa-industry"></i> Aplicación en Sistemas Reales</h2>
                
                <section>
                    <h3>Sistemas Transaccionales (OLTP)</h3>
                    <div class="concept-box">
                        <div class="r-hstack">
                            <div class="column">
                                <h4><i class="fas fa-university"></i> Características OLTP</h4>
                                <ul style="font-size: 0.9em;">
                                    <li><strong>Transacciones cortas</strong>: Pagos QR en segundos</li>
                                    <li><strong>Alta concurrencia</strong>: Miles de usuarios simultáneos</li>
                                    <li><strong>ACID estricto</strong>: Consistencia crítica</li>
                                </ul>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-balance-scale"></i> Balance Crítico</h4>
                                <p style="font-size: 0.9em;">
                                    Los sistemas de pago deben balancear <strong>velocidad</strong> con <strong>seguridad</strong>. El control de concurrencia permite ambos objetivos.
                                </p>
                            </div>
                        </div>
                    </div>
                </section>
            </section>

            <!-- Mejores Prácticas -->
            <section data-transition="convex">
                <h2><i class="fas fa-star"></i> Mejores Prácticas</h2>

                <section>
                    <h3>Principios Fundamentales</h3>
                    <div class="concept-box">
                        <div class="r-hstack">
                            <div class="column">
                                <h4><i class="fas fa-lightbulb"></i> Diseño de Transacciones</h4>
                                <ul style="font-size: 0.9em;">
                                    <li><strong>Mantén transacciones cortas</strong></li>
                                    <li><strong>Minimiza el scope de bloqueos</strong></li>
                                    <li><strong>Ordena acceso a recursos</strong></li>
                                    <li><strong>Usa niveles de aislamiento apropiados</strong></li>
                                </ul>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-exclamation-triangle"></i> Manejo de Errores</h4>
                                <ul style="font-size: 0.9em;">
                                    <li><strong>Retry logic</strong> con backoff</li>
                                    <li><strong>Timeouts configurables</strong></li>
                                    <li><strong>Mensajes claros</strong> al usuario</li>
                                    <li><strong>Idempotencia</strong> para reintentos</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h3>Próximos Pasos</h3>
                    <div class="concept-box">
                        <div class="r-hstack">
                            <div class="column">
                                <h4><i class="fas fa-flask"></i> Práctica</h4>
                                <ul style="font-size: 0.9em;">
                                    <li>Simular fenómenos de concurrencia</li>
                                    <li>Probar niveles de aislamiento</li>
                                    <li>Diseñar transacciones seguras</li>
                                </ul>
                            </div>
                            <div class="column">
                                <h4><i class="fas fa-rocket"></i> Semana 3</h4>
                                <ul style="font-size: 0.9em;">
                                    <li>Logging y checkpoints</li>
                                    <li>Recuperación ante fallos</li>
                                    <li>Write-ahead logging (WAL)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>
            </section>

            <!-- Mini-Laboratorio -->
            <section data-transition="convex">
                <h2><i class="fas fa-flask"></i> Mini-Laboratorio: Pagos Simultáneos</h2>
                
                <div class="concept-box">
                    <div class="r-hstack">
                        <div class="column">
                            <h4><i class="fas fa-play"></i> Ejercicio Práctico</h4>
                            <ol style="font-size: 0.9em;">
                                <li>Abrir dos sesiones de BD</li>
                                <li>Simular pagos simultáneos</li>
                                <li>Observar bloqueos y esperas</li>
                                <li>Probar diferentes niveles de aislamiento</li>
                            </ol>
                        </div>
                        <div class="column">
                            <h4><i class="fas fa-code"></i> Código Base</h4>
                            <pre style="background: #2d3748; color: #e2e8f0; padding: 0.8rem; border-radius: 6px; font-size: 0.7em;">
<code>-- Sesión 1: María José paga $2.50
START TRANSACTION;
SELECT saldo FROM Cuentas WHERE id = 101 FOR UPDATE;
UPDATE Cuentas SET saldo = saldo - 2.50 WHERE id = 101;
UPDATE Cuentas SET saldo = saldo + 2.50 WHERE id = 205;
INSERT INTO Pagos_QR (payment_id, cliente_id, comercio_id, monto, fecha, estado) 
VALUES ('PAY_20251106_101_205_LAB1', 101, 205, 2.50, NOW(), 'CONFIRMADO');
COMMIT;

-- Sesión 2: Edgar paga $1.25 (simultánea)
START TRANSACTION;
SELECT saldo FROM Cuentas WHERE id = 102 FOR UPDATE;
UPDATE Cuentas SET saldo = saldo - 1.25 WHERE id = 102;
UPDATE Cuentas SET saldo = saldo + 1.25 WHERE id = 205; -- ¿Espera aquí?
INSERT INTO Pagos_QR (payment_id, cliente_id, comercio_id, monto, fecha, estado) 
VALUES ('PAY_20251106_102_205_LAB2', 102, 205, 1.25, NOW(), 'CONFIRMADO');
COMMIT;</code></pre>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Final slide with attribution -->
            <section data-background-color="#f8f8f8" data-transition="convex">
                <div class="title-slide">
                    <h2>¡Gracias por su atención!</h2>
                    <div style="margin-top: 2em; font-size: 0.8em; font-style: italic; color: var(--uide-secondary);">
                        <em>Presentación basada en el compendio de Semana 2 - SGBD:<br>
                        Transacciones, Propiedades ACID, Control de Concurrencia<br>
                        y Técnicas de Bloqueo</em>
                    </div>
                    
                    <div style="margin-top: 2em; font-size: 0.9em;">
                        <strong>05 LTI_05A_300-SGBD-ASC</strong> • Universidad Internacional del Ecuador<br>
                        <em>Prof. Charlie Cárdenas Toledo, M.Sc.</em>
                    </div>
                </div>
            </section>        </div>    </div>

    <!-- Reveal.js JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.6.1/dist/reveal.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.6.1/plugin/notes/notes.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.6.1/plugin/markdown/markdown.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.6.1/plugin/highlight/highlight.js"></script>

    <!-- Custom JavaScript -->
    <script src="presentacion-clase-semana2.js"></script>

    <!-- Responsive handling script -->
    <script>
        // Responsive handling for presentation
        function handleResize() {
            // Trigger Reveal.js layout recalculation
            if (typeof Reveal !== 'undefined') {
                Reveal.layout();
            }

            // Re-render Mermaid diagrams if needed
            if (typeof mermaid !== 'undefined') {
                try {
                    mermaid.init();
                } catch (e) {
                    console.log('Mermaid re-initialization skipped');
                }
            }
        }

        // Debounced resize handler
        let resizeTimeout;
        window.addEventListener('resize', function () {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(handleResize, 250);
        });

        // Orientation change handler for mobile
        window.addEventListener('orientationchange', function () {
            setTimeout(handleResize, 500);
        });

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM loaded, initializing presentation...');
            handleResize();
        });

        // Performance optimization for mobile
        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            // Reduce animations on mobile for better performance
            document.documentElement.style.setProperty('--reveal-transition-speed', '0.3s');
        }
    </script>

    <script>
        // Initialize Reveal.js with responsive settings
        console.log('Initializing Reveal.js...');

        Reveal.initialize({
            hash: true,
            transition: 'convex',
            transitionSpeed: 'default',
            backgroundTransition: 'fade',

            // Responsive settings
            width: '100%',
            height: '100%',
            margin: 0.04,
            minScale: 0.2,
            maxScale: 2.0,

            // Learn about plugins: https://revealjs.com/plugins/
            plugins: [RevealMarkdown, RevealHighlight, RevealNotes],

            // Display controls
            controls: true,
            progress: true,
            center: true,
            touch: true,
            loop: false,

            // Keyboard navigation
            keyboard: true,

            // Overview mode
            overview: true,

            // Vertical centering of slides
            center: true,

            // Enables touch navigation on devices with touch input
            touch: true,

            // Loop the presentation
            loop: false,

            // Change the presentation direction to be RTL
            rtl: false,

            // Randomizes the order of slides each time the presentation loads
            shuffle: false,

            // Turns fragments on and off globally
            fragments: true,

            // Flags whether to include the current fragment in the URL,
            // so that reloading brings you to the same fragment position
            fragmentInURL: true,

            // Flags if the presentation is running in an embedded mode,
            // i.e. contained within a limited portion of the screen
            embedded: false,

            // Flags if we should show a help overlay when the questionmark
            // key is pressed
            help: true,

            // Flags if it should be possible to pause the presentation (blackout)
            pause: true,

            // Flags if speaker notes should be visible to all viewers
            showNotes: false,

            // Global override for autoplaying embedded media (null/true/false)
            autoPlayMedia: null,

            // Global override for preloading lazy-loaded iframes (null/true/false)
            preloadIframes: null,

            // Number of milliseconds between automatically proceeding to the
            // next slide, disabled when set to 0, this value can be overwritten
            // by using a data-autoslide attribute on your slides
            autoSlide: 0,

            // Stop auto-sliding after user input
            autoSlideStoppable: true,

            // Use this method for navigation when auto-sliding
            autoSlideMethod: null,

            // Specify the average time in seconds that you think you'll spend
            // presenting each slide. This is used to show a pacing timer in the
            // speaker view
            defaultTiming: null,

            // Enable slide navigation via mouse wheel
            mouseWheel: false,

            // The display mode that will be used to show slides
            display: 'block',

            // Hide cursor if inactive
            hideInactiveCursor: true,

            // Time before the cursor is hidden (in ms)
            hideCursorTime: 5000,

            // Opens links in an iframe preview overlay
            previewLinks: false,

            // Exposes the reveal.js API through window.postMessage
            postMessage: true,

            // Dispatches all reveal.js events to the parent window through postMessage
            postMessageEvents: false,

            // Focuses body when page changes visibility to ensure keyboard shortcuts work
            focusBodyOnPageVisibilityChange: true,

            // Transition style
            transition: 'convex', // none/fade/slide/convex/concave/zoom

            // Transition speed
            transitionSpeed: 'default', // default/fast/slow

            // Transition style for full page slide backgrounds
            backgroundTransition: 'fade', // none/fade/slide/convex/concave/zoom

            // Number of slides away from the current that are visible
            viewDistance: 3,

            // Number of slides away from the current that are visible on mobile
            // devices. It is advisable to set this to a lower number than
            // viewDistance in order to save resources.
            mobileViewDistance: 2,

            // Parallax background image
            parallaxBackgroundImage: '', // e.g. "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'"

            // Parallax background size
            parallaxBackgroundSize: '', // CSS syntax, e.g. "2100px 900px"

            // Number of pixels to move the parallax background per slide
            // - Calculated automatically unless specified
            // - Set to 0 to disable movement along an axis
            parallaxBackgroundHorizontal: null,
            parallaxBackgroundVertical: null,

            // The maximum number of pages a single slide can expand onto when printing
            // to PDF, unlimited by default
            pdfMaxPagesPerSlide: Number.POSITIVE_INFINITY,

            // Prints each fragment on a separate slide
            pdfSeparateFragments: true,

            // Offset used to reduce the height of content within exported PDF pages.
            // This exists to account for environment differences based on how you
            // print to PDF. CLI printing options, like phantomjs and wkpdf, can end
            // on precisely the total height of the document whereas in-browser
            // printing has to end one pixel before.
            pdfPageHeightOffset: -1,

            // Number of slides away from the current that will be preloaded
            preloadIframes: null,

            // Can be used to globally disable auto-animation
            autoAnimate: true,

            // Optionally provide a custom element matcher that will be
            // used to dictate which elements we can animate between.
            autoAnimateEasing: 'ease',

            // Default settings for our auto-animate transitions, can be
            // overridden per-slide or per-element via data arguments
            autoAnimateDuration: 1.0,
            autoAnimateUnmatched: true
        });

        // Log when Reveal is ready
        Reveal.on('ready', function () {
            console.log('Reveal.js is ready!');
        });

        // ===== SIMULADORES INTERACTIVOS =====
        
        // Variables globales para simuladores
        let transactionStep = 0;
        let deadlockStep = 0;
        let isolationState = {
            mariaBalance: 100,
            josephPaid: false,
            josephCommitted: false
        };
        let atomicityState = {
            mariaBalance: 50,
            restaurantBalance: 200,
            inProgress: false
        };

        // ===== SIMULADOR DE ESTADOS DE TRANSACCIÓN =====
        function startTransaction() {
            if (transactionStep > 0) return;
            
            const states = ['state-inactive', 'state-active', 'state-partial', 'state-committed'];
            const messages = [
                '<i class="fas fa-sync"></i> Listo para iniciar transacción',
                '<i class="fas fa-circle text-warning"></i> Verificando saldo y límites...',
                '<i class="fas fa-circle text-info"></i> Procesando... (entre fin_t y COMMIT)',
                '<i class="fas fa-circle text-success"></i> ¡Pago exitoso! Recibo generado'
            ];
            
            function nextStep() {
                if (transactionStep < states.length - 1) {
                    // Desactivar estado anterior
                    if (transactionStep >= 0) {
                        document.getElementById(states[transactionStep]).style.border = '2px solid #ddd';
                    }
                    
                    transactionStep++;
                    
                    // Activar nuevo estado
                    document.getElementById(states[transactionStep]).style.border = '2px solid #28a745';
                    document.getElementById('transaction-status').innerHTML = 
                        `<span style="font-size: 1.1em; font-weight: bold;">${messages[transactionStep]}</span>`;
                    
                    if (transactionStep < states.length - 1) {
                        setTimeout(nextStep, 2000);
                    }
                }
            }
            
            nextStep();
        }

        function resetTransaction() {
            transactionStep = 0;
            const states = ['state-inactive', 'state-active', 'state-partial', 'state-committed'];
            
            states.forEach((state, index) => {
                document.getElementById(state).style.border = index === 0 ? '2px solid #28a745' : '2px solid #ddd';
            });
            
            document.getElementById('transaction-status').innerHTML = 
                '<span style="font-size: 1.1em; font-weight: bold;"><i class="fas fa-sync"></i> Listo para iniciar transacción</span>';
        }

        // ===== SIMULADOR DE DEADLOCK =====
        function startDeadlockDemo() {
            if (deadlockStep > 0) return;
            
            const steps = [
                () => {
                    document.getElementById('maria-status').innerHTML = '<i class="fas fa-circle text-warning"></i> Bloqueando cuenta propia...';
                    document.getElementById('maria-lock1').innerHTML = '<i class="fas fa-lock"></i> Cuenta María José: <span style="color: #28a745; font-weight: bold;">BLOQUEADA</span>';
                },
                () => {
                    document.getElementById('joseph-status').innerHTML = '<i class="fas fa-circle text-warning"></i> Bloqueando cuenta propia...';
                    document.getElementById('joseph-lock1').innerHTML = '<i class="fas fa-lock"></i> Cuenta Joseph: <span style="color: #007bff; font-weight: bold;">BLOQUEADA</span>';
                },
                () => {
                    document.getElementById('maria-status').innerHTML = '<i class="fas fa-clock text-warning"></i> Esperando cuenta de Joseph...';
                    document.getElementById('maria-lock2').innerHTML = '<i class="fas fa-lock"></i> Cuenta Joseph: <span style="color: #dc3545; font-weight: bold;">ESPERANDO...</span>';
                },
                () => {
                    document.getElementById('joseph-status').innerHTML = '<i class="fas fa-clock text-warning"></i> Esperando cuenta de María José...';
                    document.getElementById('joseph-lock2').innerHTML = '<i class="fas fa-lock"></i> Cuenta María José: <span style="color: #dc3545; font-weight: bold;">ESPERANDO...</span>';
                },
                () => {
                    document.getElementById('deadlock-status').innerHTML = 
                        '<span style="font-size: 1.1em; font-weight: bold; color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> ¡DEADLOCK DETECTADO! Ciclo de espera circular</span>';
                },
                () => {
                    document.getElementById('deadlock-status').innerHTML = 
                        '<span style="font-size: 1.1em; font-weight: bold; color: #ffc107;"><i class="fas fa-robot"></i> SGBD resuelve: Aborta transacción más joven (Joseph)</span>';
                    document.getElementById('joseph-status').innerHTML = '<i class="fas fa-sync"></i> ROLLBACK - Reintentando...';
                    document.getElementById('joseph-lock1').innerHTML = '<i class="fas fa-unlock"></i> Cuenta Joseph: <span style="color: #666;">Liberada</span>';
                    document.getElementById('joseph-lock2').innerHTML = '<i class="fas fa-unlock"></i> Cuenta María José: <span style="color: #666;">Liberada</span>';
                },
                () => {
                    document.getElementById('maria-status').innerHTML = '<i class="fas fa-check text-success"></i> Transacción completada';
                    document.getElementById('maria-lock2').innerHTML = '<i class="fas fa-lock"></i> Cuenta Joseph: <span style="color: #28a745; font-weight: bold;">BLOQUEADA</span>';
                    document.getElementById('deadlock-status').innerHTML = 
                        '<span style="font-size: 1.1em; font-weight: bold; color: #28a745;"><i class="fas fa-check text-success"></i> Deadlock resuelto automáticamente</span>';
                }
            ];
            
            function executeStep() {
                if (deadlockStep < steps.length) {
                    steps[deadlockStep]();
                    deadlockStep++;
                    if (deadlockStep < steps.length) {
                        setTimeout(executeStep, 1500);
                    }
                }
            }
            
            executeStep();
        }

        function resetDeadlockDemo() {
            deadlockStep = 0;
            document.getElementById('maria-status').innerHTML = '<i class="fas fa-sync"></i> Esperando inicio';
            document.getElementById('joseph-status').innerHTML = '<i class="fas fa-sync"></i> Esperando inicio';
            document.getElementById('maria-lock1').innerHTML = '<i class="fas fa-unlock"></i> Cuenta María José: <span style="color: #666;">Sin bloquear</span>';
            document.getElementById('maria-lock2').innerHTML = '<i class="fas fa-unlock"></i> Cuenta Joseph: <span style="color: #666;">Sin bloquear</span>';
            document.getElementById('joseph-lock1').innerHTML = '<i class="fas fa-unlock"></i> Cuenta Joseph: <span style="color: #666;">Sin bloquear</span>';
            document.getElementById('joseph-lock2').innerHTML = '<i class="fas fa-unlock"></i> Cuenta María José: <span style="color: #666;">Sin bloquear</span>';
            document.getElementById('deadlock-status').innerHTML = 
                '<span style="font-size: 1.1em; font-weight: bold;"><i class="fas fa-clock text-warning"></i> Listo para simular deadlock</span>';
        }

        // ===== SIMULADOR DE NIVELES DE AISLAMIENTO =====
        function updateIsolationDemo() {
            const level = document.getElementById('isolation-level').value;
            const explanations = {
                'read-uncommitted': 'READ UNCOMMITTED: María José puede ver cambios no confirmados. ¡Peligroso para sistemas financieros!',
                'read-committed': 'READ COMMITTED: María José solo ve cambios confirmados. No verá el pago de Joseph hasta que haga COMMIT.',
                'repeatable-read': 'REPEATABLE READ: María José verá el mismo saldo durante toda su transacción, sin importar otros cambios.',
                'serializable': 'SERIALIZABLE: Máximo aislamiento. Las transacciones se ejecutan como si fueran secuenciales.'
            };
            
            document.getElementById('isolation-explanation').innerHTML = `<strong>${level.toUpperCase()}:</strong> ${explanations[level]}`;
            resetIsolationDemo();
        }

        function mariaReadBalance() {
            const level = document.getElementById('isolation-level').value;
            let balance = isolationState.mariaBalance;
            
            if (level === 'read-uncommitted' && isolationState.josephPaid && !isolationState.josephCommitted) {
                balance = 50; // Ve el cambio no confirmado
            } else if (isolationState.josephCommitted) {
                balance = 50; // Ve el cambio confirmado
            }
            
            document.getElementById('maria-balance-display').innerHTML = `Saldo: $${balance}.00`;
            
            if (level === 'read-uncommitted' && isolationState.josephPaid && !isolationState.josephCommitted) {
                document.getElementById('maria-balance-display').style.background = '#fff3cd';
                document.getElementById('maria-balance-display').innerHTML += ' <span style="color: #856404;">(⚠️ No confirmado)</span>';
            }
        }

        function josephMakePayment() {
            isolationState.josephPaid = true;
            document.getElementById('joseph-status-display').innerHTML = 'Estado: Pago ejecutado (sin COMMIT)';
            document.getElementById('joseph-status-display').style.background = '#fff3cd';
            
            // Habilitar botón COMMIT
            const commitBtn = document.querySelector('#joseph-isolation-actions button:last-child');
            commitBtn.disabled = false;
            commitBtn.style.opacity = '1';
        }

        function josephCommit() {
            isolationState.josephCommitted = true;
            document.getElementById('joseph-status-display').innerHTML = 'Estado: ✅ COMMIT - Pago confirmado';
            document.getElementById('joseph-status-display').style.background = '#d4edda';
            
            // Deshabilitar botón COMMIT
            const commitBtn = document.querySelector('#joseph-isolation-actions button:last-child');
            commitBtn.disabled = true;
            commitBtn.style.opacity = '0.5';
        }

        function resetIsolationDemo() {
            isolationState = {
                mariaBalance: 100,
                josephPaid: false,
                josephCommitted: false
            };
            
            document.getElementById('maria-balance-display').innerHTML = 'Saldo: $100.00';
            document.getElementById('maria-balance-display').style.background = '#f8f9fa';
            document.getElementById('joseph-status-display').innerHTML = 'Estado: Inactivo';
            document.getElementById('joseph-status-display').style.background = '#f8f9fa';
            
            const commitBtn = document.querySelector('#joseph-isolation-actions button:last-child');
            commitBtn.disabled = true;
            commitBtn.style.opacity = '0.5';
        }

        // ===== SIMULADOR DE 2PL =====
        function start2PLDemo() {
            const timeline = document.getElementById('twopl-timeline');
            const expansionLocks = document.getElementById('expansion-locks').children;
            const contractionLocks = document.getElementById('contraction-locks').children;
            const expansionStatus = document.getElementById('expansion-status');
            const contractionStatus = document.getElementById('contraction-status');
            const phaseArrow = document.getElementById('phase-arrow');
            
            const steps = [
                () => {
                    timeline.innerHTML = '<i class="fas fa-sync"></i> BEGIN TRANSACTION; - Iniciando protocolo 2PL';
                    expansionStatus.innerHTML = 'Fase activa - Adquiriendo bloqueos';
                    phaseArrow.innerHTML = '<i class="fas fa-play"></i>';
                },
                () => {
                    timeline.innerHTML = '<i class="fas fa-lock"></i> LOCK cuenta_cliente (ID: 101) - Orden estable';
                    expansionLocks[0].innerHTML = '<i class="fas fa-lock"></i> Cuenta Cliente: <span style="color: #28a745; font-weight: bold;">BLOQUEADA</span>';
                    expansionLocks[0].style.background = '#d4edda';
                },
                () => {
                    timeline.innerHTML = '<i class="fas fa-lock"></i> LOCK cuenta_comercio (ID: 205) - Segundo bloqueo';
                    expansionLocks[1].innerHTML = '<i class="fas fa-lock"></i> Cuenta Comercio: <span style="color: #28a745; font-weight: bold;">BLOQUEADA</span>';
                    expansionLocks[1].style.background = '#d4edda';
                },
                () => {
                    timeline.innerHTML = '<i class="fas fa-credit-card"></i> Ejecutando operaciones de pago (débito/crédito)';
                    expansionStatus.innerHTML = 'Todos los bloqueos adquiridos';
                    phaseArrow.innerHTML = '<i class="fas fa-clock"></i>';
                },
                () => {
                    timeline.innerHTML = '<i class="fas fa-check"></i> COMMIT; - Iniciando fase de contracción';
                    contractionStatus.innerHTML = 'Liberando todos los bloqueos';
                    phaseArrow.innerHTML = '<i class="fas fa-arrow-left"></i>';
                    phaseArrow.style.color = '#ffc107';
                },
                () => {
                    timeline.innerHTML = '<i class="fas fa-unlock"></i> UNLOCK cuenta_cliente - Primer desbloqueo';
                    contractionLocks[0].innerHTML = '<i class="fas fa-unlock"></i> Cuenta Cliente: <span style="color: #666;">LIBERADA</span>';
                    contractionLocks[0].style.background = '#f8f9fa';
                    expansionLocks[0].innerHTML = '<i class="fas fa-unlock"></i> Cuenta Cliente: <span style="color: #666;">LIBERADA</span>';
                    expansionLocks[0].style.background = '#f8f9fa';
                },
                () => {
                    timeline.innerHTML = '<i class="fas fa-unlock"></i> UNLOCK cuenta_comercio - Último desbloqueo';
                    contractionLocks[1].innerHTML = '<i class="fas fa-unlock"></i> Cuenta Comercio: <span style="color: #666;">LIBERADA</span>';
                    contractionLocks[1].style.background = '#f8f9fa';
                    expansionLocks[1].innerHTML = '<i class="fas fa-unlock"></i> Cuenta Comercio: <span style="color: #666;">LIBERADA</span>';
                    expansionLocks[1].style.background = '#f8f9fa';
                },
                () => {
                    timeline.innerHTML = '<i class="fas fa-check text-success"></i> Protocolo 2PL completado - Serializabilidad garantizada';
                    contractionStatus.innerHTML = 'Todos los bloqueos liberados';
                    expansionStatus.innerHTML = 'Transacción finalizada';
                    phaseArrow.innerHTML = '<i class="fas fa-check text-success"></i>';
                    phaseArrow.style.color = '#28a745';
                }
            ];
            
            let currentStep = 0;
            
            function executeStep() {
                if (currentStep < steps.length) {
                    steps[currentStep]();
                    currentStep++;
                    if (currentStep < steps.length) {
                        setTimeout(executeStep, 2000);
                    }
                }
            }
            
            executeStep();
        }

        function reset2PLDemo() {
            const expansionLocks = document.getElementById('expansion-locks').children;
            const contractionLocks = document.getElementById('contraction-locks').children;
            
            // Reset expansion phase
            expansionLocks[0].innerHTML = '<i class="fas fa-unlock"></i> Cuenta Cliente: Disponible';
            expansionLocks[0].style.background = '#f8f9fa';
            expansionLocks[1].innerHTML = '<i class="fas fa-unlock"></i> Cuenta Comercio: Disponible';
            expansionLocks[1].style.background = '#f8f9fa';
            
            // Reset contraction phase
            contractionLocks[0].innerHTML = '<i class="fas fa-unlock"></i> Cuenta Cliente: Disponible';
            contractionLocks[0].style.background = '#f8f9fa';
            contractionLocks[1].innerHTML = '<i class="fas fa-unlock"></i> Cuenta Comercio: Disponible';
            contractionLocks[1].style.background = '#f8f9fa';
            
            // Reset status
            document.getElementById('expansion-status').innerHTML = 'Esperando inicio...';
            document.getElementById('contraction-status').innerHTML = 'Esperando COMMIT...';
            document.getElementById('twopl-timeline').innerHTML = '<i class="fas fa-lightbulb"></i> Listo para demostrar protocolo 2PL';
            document.getElementById('phase-arrow').innerHTML = '<i class="fas fa-pause"></i>';
            document.getElementById('phase-arrow').style.color = '#ffc107';
        }

        // ===== SIMULADOR DE ATOMICIDAD =====
        function startAtomicityDemo() {
            if (atomicityState.inProgress) return;
            
            atomicityState.inProgress = true;
            const stepLog = document.getElementById('step-log');
            
            const steps = [
                '<i class="fas fa-sync"></i> START TRANSACTION;',
                '<i class="fas fa-search"></i> Verificando saldo de María José... <i class="fas fa-check text-success"></i>',
                '<i class="fas fa-minus-circle"></i> Debitando $2.50 de cuenta María José...',
                '<i class="fas fa-plus-circle"></i> Acreditando $2.50 a cuenta Restaurante...',
                '<i class="fas fa-file-alt"></i> Registrando pago en tabla Pagos_QR...',
                '<i class="fas fa-check text-success"></i> COMMIT; - ¡Transacción completada exitosamente!'
            ];
            
            let currentStep = 0;
            
            function executeStep() {
                stepLog.innerHTML = steps[currentStep];
                
                if (currentStep === 2) {
                    // Debitar María José
                    document.getElementById('maria-balance').innerHTML = '$22.50';
                    document.getElementById('maria-operation').innerHTML = 'Débito: -$2.50';
                    document.getElementById('maria-operation').style.color = '#dc3545';
                }
                
                if (currentStep === 3) {
                    // Acreditar Restaurante
                    document.getElementById('restaurant-balance').innerHTML = '$452.50';
                    document.getElementById('restaurant-operation').innerHTML = 'Crédito: +$2.50';
                    document.getElementById('restaurant-operation').style.color = '#28a745';
                    document.getElementById('operation-arrow').innerHTML = '<i class="fas fa-check text-success"></i>';
                    document.getElementById('operation-arrow').style.color = '#28a745';
                }
                
                currentStep++;
                if (currentStep < steps.length) {
                    setTimeout(executeStep, 1500);
                } else {
                    atomicityState.inProgress = false;
                    atomicityState.mariaBalance = 22.50;
                    atomicityState.restaurantBalance = 452.50;
                }
            }
            
            executeStep();
        }

        function simulateFailure() {
            if (atomicityState.inProgress) return;
            
            atomicityState.inProgress = true;
            const stepLog = document.getElementById('step-log');
            
            const steps = [
                '<i class="fas fa-sync"></i> START TRANSACTION;',
                '<i class="fas fa-search"></i> Verificando saldo de María José... <i class="fas fa-check text-success"></i>',
                '<i class="fas fa-minus-circle"></i> Debitando $2.50 de cuenta María José...',
                '<i class="fas fa-bolt text-danger"></i> ¡FALLA DE CONEXIÓN! Sistema detecta transacción incompleta',
                '<i class="fas fa-sync text-warning"></i> ROLLBACK automático iniciado...',
                '<i class="fas fa-undo text-info"></i> Restaurando saldo de María José...',
                '<i class="fas fa-check text-success"></i> ROLLBACK completado - Estado original restaurado'
            ];
            
            let currentStep = 0;
            
            function executeStep() {
                stepLog.innerHTML = steps[currentStep];
                
                if (currentStep === 2) {
                    // Debitar temporalmente
                    document.getElementById('maria-balance').innerHTML = '$22.50';
                    document.getElementById('maria-balance').style.color = '#ffc107';
                    document.getElementById('maria-operation').innerHTML = 'Débito temporal: -$2.50';
                    document.getElementById('maria-operation').style.color = '#ffc107';
                    document.getElementById('operation-arrow').innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i>';
                    document.getElementById('operation-arrow').style.color = '#ffc107';
                }
                
                if (currentStep === 5) {
                    // Rollback
                    document.getElementById('maria-balance').innerHTML = '$25.00';
                    document.getElementById('maria-balance').style.color = '#28a745';
                    document.getElementById('maria-operation').innerHTML = 'Cuenta origen';
                    document.getElementById('maria-operation').style.color = '#666';
                    document.getElementById('operation-arrow').innerHTML = '<i class="fas fa-sync text-danger"></i>';
                    document.getElementById('operation-arrow').style.color = '#dc3545';
                }
                
                currentStep++;
                if (currentStep < steps.length) {
                    setTimeout(executeStep, 1500);
                } else {
                    atomicityState.inProgress = false;
                    document.getElementById('operation-arrow').innerHTML = '<i class="fas fa-arrow-right text-warning"></i>';
                    document.getElementById('operation-arrow').style.color = '#ffc107';
                }
            }
            
            executeStep();
        }

        function resetAtomicityDemo() {
            atomicityState = {
                mariaBalance: 25,
                restaurantBalance: 450,
                inProgress: false
            };
            
            document.getElementById('maria-balance').innerHTML = '$25.00';
            document.getElementById('maria-balance').style.color = '#28a745';
            document.getElementById('restaurant-balance').innerHTML = '$200.00';
            document.getElementById('restaurant-balance').style.color = '#007bff';
            document.getElementById('maria-operation').innerHTML = 'Cuenta origen';
            document.getElementById('maria-operation').style.color = '#666';
            document.getElementById('restaurant-operation').innerHTML = 'Cuenta destino';
            document.getElementById('restaurant-operation').style.color = '#666';
            document.getElementById('operation-arrow').innerHTML = '➡️';
            document.getElementById('operation-arrow').style.color = '#ffc107';
            document.getElementById('step-log').innerHTML = '💡 Listo para simular transacción atómica';
        }

        // SGBD Reference Guide Function
        function showSGBDReference() {
            const sgbdInfo = `
                <div style="max-width: 1000px; padding: 25px; background: white; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-height: 85vh; overflow-y: auto;">
                    <h3 style="color: #2c5282; margin-top: 0; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; text-align: center;">
                        <i class="fas fa-database" style="margin-right: 8px;"></i>Guía Rápida: SGBD & MySQL
                    </h3>
                    
                    <!-- Contenido en dos columnas -->
                    <div style="display: flex; gap: 25px; margin-top: 20px;">
                        
                        <!-- COLUMNA IZQUIERDA: Conceptos Teóricos -->
                        <div style="flex: 1; min-width: 0;">
                            <h4 style="color: #2c5282; margin: 0 0 15px 0; font-size: 16px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px;">
                                <i class="fas fa-graduation-cap" style="margin-right: 6px;"></i>Conceptos Teóricos SGBD
                            </h4>
                            
                            <div style="margin: 15px 0;">
                                <h5 style="color: #2d3748; margin: 8px 0 4px 0; font-size: 13px;">
                                    <i class="fas fa-exchange-alt" style="color: #4299e1;"></i> Estados de Transacción
                                </h5>
                                <p style="margin: 0; font-size: 11px; color: #4a5568; line-height: 1.4;">• <strong>Activa:</strong> Ejecutando operaciones<br>• <strong>Parcialmente confirmada:</strong> Última operación ejecutada<br>• <strong>Confirmada:</strong> COMMIT exitoso<br>• <strong>Abortada:</strong> ROLLBACK ejecutado</p>
                            </div>
                            
                            <div style="margin: 15px 0;">
                                <h5 style="color: #2d3748; margin: 8px 0 4px 0; font-size: 13px;">
                                    <i class="fas fa-shield-alt" style="color: #48bb78;"></i> Propiedades ACID
                                </h5>
                                <p style="margin: 0; font-size: 11px; color: #4a5568; line-height: 1.4;">• <strong>A</strong>tomicidad: Todo o nada - transacción completa<br>• <strong>C</strong>onsistencia: Estados válidos - reglas de negocio<br>• <strong>I</strong>solation: Independencia - niveles de aislamiento<br>• <strong>D</strong>urabilidad: Permanencia - cambios persisten</p>
                            </div>

                            <div style="margin: 15px 0;">
                                <h5 style="color: #2d3748; margin: 8px 0 4px 0; font-size: 13px;">
                                    <i class="fas fa-lock" style="color: #ed8936;"></i> Control de Concurrencia
                                </h5>
                                <p style="margin: 0; font-size: 11px; color: #4a5568; line-height: 1.4;">• <strong>Pesimista:</strong> Bloqueos preventivos (2PL)<br>• <strong>Optimista:</strong> Validación posterior<br>• <strong>MVCC:</strong> Control multiversión (InnoDB)<br>• <strong>Deadlock detection:</strong> Automático en MySQL</p>
                            </div>
                            
                            <div style="margin: 15px 0;">
                                <h5 style="color: #2d3748; margin: 8px 0 4px 0; font-size: 13px;">
                                    <i class="fas fa-key" style="color: #9f7aea;"></i> Tipos de Bloqueo
                                </h5>
                                <p style="margin: 0; font-size: 11px; color: #4a5568; line-height: 1.4;">• <strong>Compartido (S):</strong> Múltiples lecturas<br>• <strong>Exclusivo (X):</strong> Lectura y escritura exclusiva<br>• <strong>Actualización (U):</strong> Temporal para leer-escribir<br>• <strong>Intención (IS/IX):</strong> Jerarquía de bloqueos</p>
                            </div>

                            <div style="margin: 15px 0;">
                                <h5 style="color: #2d3748; margin: 8px 0 4px 0; font-size: 13px;">
                                    <i class="fas fa-exclamation-triangle" style="color: #e53e3e;"></i> Problemas de Concurrencia
                                </h5>
                                <p style="margin: 0; font-size: 11px; color: #4a5568; line-height: 1.4;">• <strong>Deadlock:</strong> Espera circular - resuelto automáticamente<br>• <strong>Dirty Read:</strong> Leer datos no confirmados<br>• <strong>Non-repeatable Read:</strong> Lecturas inconsistentes<br>• <strong>Phantom Read:</strong> Filas fantasma en rangos</p>
                            </div>
                        </div>
                        
                        <!-- COLUMNA DERECHA: Implementación MySQL -->
                        <div style="flex: 1; min-width: 0;">
                            <h4 style="color: #2c5282; margin: 0 0 15px 0; font-size: 16px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px;">
                                <i class="fas fa-code" style="margin-right: 6px;"></i>Implementación MySQL
                            </h4>
                            
                            <div style="margin: 15px 0;">
                                <h5 style="color: #2d3748; margin: 8px 0 4px 0; font-size: 13px;">
                                    <i class="fas fa-play" style="color: #4299e1;"></i> Sintaxis de Transacciones
                                </h5>
                                <div style="background: #f7fafc; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 10px; margin: 5px 0; border-left: 3px solid #4299e1;">
                                    <strong>START TRANSACTION;</strong> -- Sintaxis estándar recomendada<br>
                                    <strong>BEGIN;</strong> -- Alias soportado<br>
                                    <strong>COMMIT;</strong> -- Confirma cambios permanentemente<br>
                                    <strong>ROLLBACK;</strong> -- Cancela y deshace cambios
                                </div>
                                <p style="margin: 0; font-size: 10px; color: #4a5568; line-height: 1.3;">• START TRANSACTION es la sintaxis SQL estándar recomendada<br>• BEGIN y BEGIN WORK son aliases soportados</p>
                            </div>

                            <div style="margin: 15px 0;">
                                <h5 style="color: #2d3748; margin: 8px 0 4px 0; font-size: 13px;">
                                    <i class="fas fa-cog" style="color: #805ad5;"></i> Modificadores de Transacción
                                </h5>
                                <div style="background: #f7fafc; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 10px; margin: 5px 0; border-left: 3px solid #805ad5;">
                                    START TRANSACTION <strong>WITH CONSISTENT SNAPSHOT</strong>;<br>
                                    START TRANSACTION <strong>READ WRITE</strong>;<br>
                                    START TRANSACTION <strong>READ ONLY</strong>;
                                </div>
                                <p style="margin: 0; font-size: 10px; color: #4a5568; line-height: 1.3;">• WITH CONSISTENT SNAPSHOT: Para InnoDB<br>• READ WRITE/READ ONLY: Control de acceso</p>
                            </div>

                            <div style="margin: 15px 0;">
                                <h5 style="color: #2d3748; margin: 8px 0 4px 0; font-size: 13px;">
                                    <i class="fas fa-layer-group" style="color: #38b2ac;"></i> Niveles de Aislamiento
                                </h5>
                                <div style="background: #f7fafc; padding: 8px; border-radius: 4px; font-size: 10px; margin: 5px 0; border-left: 3px solid #38b2ac;">
                                    <strong>SERIALIZABLE</strong> - Máximo aislamiento<br>
                                    <strong>REPEATABLE READ</strong> - Por defecto en MySQL<br>
                                    <strong>READ COMMITTED</strong> - Evita lecturas sucias<br>
                                    <strong>READ UNCOMMITTED</strong> - Mínimo aislamiento
                                </div>
                                <p style="margin: 0; font-size: 10px; color: #4a5568; line-height: 1.3;">• MySQL usa REPEATABLE READ por defecto<br>• Cambiar con SET TRANSACTION ISOLATION LEVEL</p>
                            </div>
                            
                            <div style="margin: 15px 0;">
                                <h5 style="color: #2d3748; margin: 8px 0 4px 0; font-size: 13px;">
                                    <i class="fas fa-lock" style="color: #9f7aea;"></i> Bloqueos Explícitos
                                </h5>
                                <div style="background: #f7fafc; padding: 8px; border-radius: 4px; font-size: 10px; margin: 5px 0; border-left: 3px solid #9f7aea;">
                                    SELECT ... <strong>FOR UPDATE</strong>; -- Bloqueo exclusivo<br>
                                    SELECT ... <strong>FOR SHARE</strong>; -- Bloqueo compartido<br>
                                    SELECT ... <strong>LOCK IN SHARE MODE</strong>; -- Alias
                                </div>
                            </div>

                            <div style="margin: 15px 0;">
                                <h5 style="color: #2d3748; margin: 8px 0 4px 0; font-size: 13px;">
                                    <i class="fas fa-tools" style="color: #d69e2e;"></i> Configuración MySQL
                                </h5>
                                <div style="background: #f7fafc; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 10px; margin: 5px 0; border-left: 3px solid #d69e2e;">
                                    SET autocommit = 0; -- Deshabilitar autocommit<br>
                                    SET autocommit = 1; -- Habilitar autocommit<br>
                                    SHOW ENGINE INNODB STATUS; -- Ver deadlocks
                                </div>
                                <p style="margin: 0; font-size: 10px; color: #4a5568; line-height: 1.3;">• autocommit habilitado por defecto<br>• Cada statement es atómico sin transacción explícita</p>
                            </div>

                            <div style="margin: 15px 0;">
                                <h5 style="color: #2d3748; margin: 8px 0 4px 0; font-size: 13px;">
                                    <i class="fas fa-lightbulb" style="color: #f6ad55;"></i> Mejores Prácticas
                                </h5>
                                <p style="margin: 0; font-size: 10px; color: #4a5568; line-height: 1.3;">• Mantener transacciones cortas<br>• Orden consistente de bloqueos (evitar deadlocks)<br>• Usar FOR UPDATE solo cuando necesario<br>• Manejar reintentos automáticos en deadlocks</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 25px; text-align: center; border-top: 1px solid #e2e8f0; padding-top: 15px;">
                        <p style="font-size: 10px; color: #718096; margin: 5px 0;">Basado en MySQL 8.4 Official Documentation</p>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="background: #4299e1; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">
                            <i class="fas fa-times"></i> Cerrar Guía
                        </button>
                    </div>
                </div>
            `;
            
            // Remove existing overlay if any
            const existingOverlay = document.getElementById('sgbd-overlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            
            // Create overlay
            const overlay = document.createElement('div');
            overlay.id = 'sgbd-overlay';
            overlay.style.cssText = `
                position: fixed; 
                top: 0; left: 0; 
                width: 100%; height: 100%; 
                background: rgba(0,0,0,0.7); 
                display: flex; 
                justify-content: center; 
                align-items: center; 
                z-index: 10000;
                backdrop-filter: blur(3px);
            `;
            overlay.innerHTML = sgbdInfo;
            
            // Close on overlay click
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
            
            document.body.appendChild(overlay);
        }
    </script>

</body>

</html>